<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JKKN AI Assessment Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f4f8; min-height: 100vh; overflow-y: auto; }
        
        .header {
            background: linear-gradient(135deg, #003D5B, #00587a);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 1.3rem; }
        .user-badge { background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 6px; }
        .db-status { font-size: 0.75rem; padding: 0.3rem 0.6rem; border-radius: 4px; margin-left: 1rem; }
        .db-online { background: #28a745; }
        .db-offline { background: #dc3545; }
        
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-primary { background: #FF6B35; color: white; }
        .btn-primary:hover { background: #e55a25; }
        .btn-secondary { background: #00A7E1; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-outline { background: transparent; border: 2px solid white; color: white; }
        .btn-lg { padding: 1rem 2rem; font-size: 1.1rem; }
        .btn-xl { padding: 1.2rem 3rem; font-size: 1.3rem; }
        
        .hidden { display: none !important; }
        
        /* Login */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 70px);
            padding: 2rem;
        }
        .login-box {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            padding: 2.5rem;
            width: 100%;
            max-width: 500px;
        }
        .login-box h2 { text-align: center; margin-bottom: 1.5rem; color: #003D5B; }
        
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; }
        .tab {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-align: center;
        }
        .tab.active { border-color: #FF6B35; background: #fff5f0; color: #FF6B35; }
        
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.4rem; font-weight: 600; color: #333; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.7rem;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
        }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #00A7E1; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        
        /* Assessment */
        #assessmentPage {
            min-height: 100vh;
            overflow-y: auto;
        }
        
        .assessment-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 1rem;
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
            align-items: start;
        }
        
        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            height: fit-content;
            position: sticky;
            top: 1rem;
        }
        
        .main-content {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow: visible;
            min-height: auto;
        }
        
        .scenario-box {
            background: linear-gradient(135deg, #e8f4f8, #f0f7fa);
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 5px solid #00A7E1;
            margin-bottom: 1.5rem;
        }
        .scenario-box h2 { 
            color: #003D5B; 
            margin-bottom: 1rem; 
            font-size: 1.4rem; 
            font-weight: 700; 
        }
        .scenario-box .scenario-content { 
            font-size: 1rem; 
            line-height: 2; 
            color: #333;
        }
        .scenario-box .scenario-content strong {
            color: #003D5B;
        }
        .scenario-box .scenario-content ul {
            margin: 0.5rem 0 0.5rem 1.5rem;
            padding: 0;
        }
        .scenario-box .scenario-content li {
            margin: 0.3rem 0;
        }
        
        .q-badge {
            background: linear-gradient(135deg, #003D5B, #00A7E1);
            color: white;
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            font-family: monospace;
            font-weight: 700;
            font-size: 1rem;
            display: inline-block;
        }
        
        .timer-box {
            background: #f5f7fa;
            padding: 0.8rem;
            border-radius: 10px;
            text-align: center;
            margin: 0.8rem 0;
        }
        .timer {
            font-size: 1.5rem;
            font-weight: 700;
            color: #003D5B;
            font-family: monospace;
        }
        
        .checklist { background: #f8f9fa; padding: 0.8rem; border-radius: 8px; margin-top: 0.8rem; }
        .checklist h4 { margin-bottom: 0.5rem; font-size: 0.95rem; }
        .check-item { padding: 0.25rem 0; font-size: 0.9rem; }
        .check-item.done { color: #28a745; }
        
        .task-section {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }
        .task-title { font-weight: 700; color: #003D5B; font-size: 1rem; }
        .task-marks { background: #FF6B35; color: white; padding: 0.25rem 0.6rem; border-radius: 20px; font-weight: 600; font-size: 0.85rem; }
        
        .code-editor {
            width: 100%;
            min-height: 200px;
            max-height: 400px;
            padding: 0.8rem;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            border: 2px solid #333;
            border-radius: 8px;
            background: #1e1e1e;
            color: #d4d4d4;
            resize: vertical;
        }
        
        .text-area {
            width: 100%;
            min-height: 120px;
            max-height: 300px;
            padding: 0.8rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
            resize: vertical;
        }
        
        /* Screenshot */
        .screenshot-section {
            border: 2px dashed #00A7E1;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f0f9ff;
        }
        .screenshot-section h3 { font-size: 1rem; margin-bottom: 0.5rem; }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            background: white;
        }
        .upload-area:hover { border-color: #00A7E1; }
        .upload-area.has-file { border-color: #28a745; background: #f0fff4; }
        .upload-icon { font-size: 2rem; }
        
        .preview-box { margin-top: 0.8rem; display: none; }
        .preview-box.active { display: block; }
        .preview-img { max-width: 100%; max-height: 200px; border-radius: 8px; border: 2px solid #28a745; }
        
        /* SUBMIT BUTTONS */
        .submit-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #e0e0e0;
            gap: 0.8rem;
            flex-wrap: wrap;
            position: sticky;
            bottom: 0;
            background: white;
            padding-bottom: 0.5rem;
        }
        
        .save-status { color: #666; font-size: 0.9rem; }
        .save-status.saved { color: #28a745; font-weight: 600; }
        
        .button-group { display: flex; gap: 0.8rem; flex-wrap: wrap; }
        
        /* Final Submit */
        #finalSubmitBtn {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: 700;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(220, 53, 69, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(220, 53, 69, 0.7); }
        }
        
        /* RESULT MODAL */
        .result-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 999999;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            box-sizing: border-box;
        }
        .result-overlay.show { display: flex !important; }
        
        .result-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            max-width: 500px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            animation: bounceIn 0.5s;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .result-icon { font-size: 3.5rem; }
        .result-title { font-size: 1.5rem; color: #003D5B; margin: 0.5rem 0; }
        .result-score {
            font-size: 2.5rem;
            font-weight: 800;
            color: #FF6B35;
            margin: 0.5rem 0;
        }
        .result-breakdown {
            background: #f5f7fa;
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: left;
            flex-shrink: 0;
        }
        .result-breakdown h4 { margin: 0 0 0.5rem 0; font-size: 1rem; }
        .bd-row {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9rem;
        }
        .bd-row:last-child { border: none; }
        .bd-row.total { background: #003D5B; color: white; margin: 0.5rem -1rem -1rem; padding: 0.8rem 1rem; border-radius: 0 0 8px 8px; font-weight: 700; }
        
        .result-card .btn-xl {
            margin-top: 1rem;
            flex-shrink: 0;
        }
        
        /* Mobile adjustments for result modal */
        @media (max-height: 700px) {
            .result-card { padding: 1.5rem; }
            .result-icon { font-size: 2.5rem; }
            .result-title { font-size: 1.2rem; }
            .result-score { font-size: 2rem; }
            .bd-row { padding: 0.3rem 0; font-size: 0.85rem; }
        }
        
        /* Dashboard */
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: white; padding: 1.5rem; border-radius: 12px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
        .stat-card h4 { color: #666; font-size: 0.85rem; }
        .stat-card .value { font-size: 2rem; font-weight: 700; color: #003D5B; }
        
        .filters { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .filters select { padding: 0.6rem 1rem; border: 2px solid #e0e0e0; border-radius: 6px; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 15px rgba(0,0,0,0.08); }
        th { background: #003D5B; color: white; padding: 1rem; text-align: left; }
        td { padding: 0.8rem; border-bottom: 1px solid #eee; }
        tr:hover { background: #f8f9fa; }
        
        .score-badge { padding: 0.3rem 0.7rem; border-radius: 20px; font-weight: 600; }
        .score-high { background: #d4edda; color: #155724; }
        .score-medium { background: #fff3cd; color: #856404; }
        .score-low { background: #f8d7da; color: #721c24; }
        
        .status-badge { padding: 0.25rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
        .status-saved { background: #fff3cd; color: #856404; }
        .status-submitted { background: #d4edda; color: #155724; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; padding: 0.5rem; box-sizing: border-box; }
        .modal.active { display: flex; }
        .modal-box { background: white; border-radius: 16px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 1.5rem; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #eee; }
        .modal-close { background: #f5f5f5; border: none; font-size: 1.5rem; cursor: pointer; width: 40px; height: 40px; border-radius: 50%; }
        
        pre { background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 8px; overflow-x: auto; max-height: 300px; }
        
        .loading { text-align: center; padding: 2rem; color: #666; }
        .spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid #e0e0e0; border-top-color: #FF6B35; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @media (max-width: 900px) {
            .assessment-layout { 
                grid-template-columns: 1fr; 
                padding: 0.5rem;
            }
            .sidebar {
                position: relative;
                top: 0;
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                padding: 0.8rem;
            }
            .sidebar > div:last-child { grid-column: span 2; }
            .timer { font-size: 1.2rem; }
            .main-content { padding: 1rem; }
            .scenario-box { padding: 1rem; }
            .scenario-box h2 { font-size: 1.2rem; }
            .scenario-box .scenario-content { font-size: 0.95rem; line-height: 1.8; }
            .task-section { padding: 0.8rem; }
            .code-editor { min-height: 150px; font-size: 12px; }
            .text-area { min-height: 100px; }
            .submit-row { 
                flex-direction: column; 
                align-items: stretch;
                position: relative;
            }
            .button-group { 
                flex-direction: column; 
                width: 100%;
            }
            .button-group button { width: 100%; }
            #finalSubmitBtn { padding: 0.8rem 1rem; font-size: 0.95rem; }
            .form-row { grid-template-columns: 1fr; }
        }
        
        @media (max-height: 700px) {
            .code-editor { min-height: 120px; }
            .text-area { min-height: 80px; }
            .upload-area { padding: 1rem; }
            .upload-icon { font-size: 1.5rem; }
            .preview-img { max-height: 150px; }
        }
    </style>
</head>
<body>

<!-- RESULT MODAL -->
<div class="result-overlay" id="resultOverlay" onclick="event.target===this && closeResultAndLogout()">
    <div class="result-card">
        <button onclick="closeResultAndLogout()" style="position:absolute;top:10px;right:15px;background:none;border:none;font-size:24px;cursor:pointer;color:#666">&times;</button>
        <div class="result-icon" id="resIcon">üéâ</div>
        <div class="result-title" id="resTitle">Submitted!</div>
        <div class="result-score" id="resScore">85/100</div>
        <div class="result-breakdown" id="resBreakdown"></div>
        <p style="color:#666;margin-bottom:1rem;font-size:0.9rem">Your submission has been saved to cloud database.</p>
        <button class="btn btn-primary btn-lg" onclick="closeResultAndLogout()" style="width:100%">‚úì Done - Logout</button>
    </div>
</div>

<header class="header">
    <h1>üéì JKKN AI Assessment Portal</h1>
    <div style="display:flex;gap:1rem;align-items:center">
        <span class="db-status" id="dbStatus">‚è≥ Connecting...</span>
        <span class="user-badge" id="userBadge"></span>
        <button class="btn btn-outline" id="logoutBtn" onclick="logout()" style="display:none">Logout</button>
    </div>
</header>

<!-- LOGIN -->
<div id="loginPage" class="login-container">
    <div class="login-box">
        <h2>üöÄ Start Assessment</h2>
        <p style="text-align:center;color:#666;margin-bottom:1rem" id="cloudStatus">‚è≥ Connecting to cloud...</p>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('learner')">üë®‚Äçüéì Learner</div>
            <div class="tab" onclick="switchTab('facilitator')">üë®‚Äçüè´ Facilitator</div>
            <div class="tab" onclick="switchTab('admin')">‚öôÔ∏è Admin</div>
        </div>

        <div id="learnerForm">
            <div class="form-group">
                <label>Full Name *</label>
                <input type="text" id="learnerName" placeholder="Your name">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Roll Number *</label>
                    <input type="text" id="rollNo" placeholder="e.g., 21CS001">
                </div>
                <div class="form-group">
                    <label>Department *</label>
                    <select id="department">
                        <option value="">Select</option>
                        <option value="CSE/IT">CSE/IT</option>
                        <option value="ECE">ECE</option>
                        <option value="EEE">EEE</option>
                        <option value="MECH">MECH</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Year *</label>
                    <select id="year">
                        <option value="">Select</option>
                        <option value="2nd Year">2nd Year</option>
                        <option value="3rd Year">3rd Year</option>
                        <option value="4th Year">4th Year</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="email" placeholder="your@email.com">
                </div>
            </div>
            <div class="form-group">
                <label>Phone *</label>
                <input type="tel" id="phone" placeholder="10-digit number">
            </div>
            <button class="btn btn-primary btn-lg" style="width:100%;margin-top:1rem" onclick="startAssessment()">
                üöÄ Start Assessment
            </button>
        </div>

        <div id="facilitatorForm" class="hidden">
            <div class="form-group">
                <label>Name *</label>
                <input type="text" id="facName">
            </div>
            <div class="form-group">
                <label>Department *</label>
                <select id="facDept">
                    <option value="">Select</option>
                    <option value="CSE/IT">CSE/IT</option>
                    <option value="ECE">ECE</option>
                    <option value="EEE">EEE</option>
                    <option value="MECH">MECH</option>
                </select>
            </div>
            <div class="form-group">
                <label>Access Code *</label>
                <input type="password" id="facCode" placeholder="Department code">
            </div>
            <button class="btn btn-primary btn-lg" style="width:100%;margin-top:1rem" onclick="loginFacilitator()">
                üìä Access Dashboard
            </button>
        </div>

        <div id="adminForm" class="hidden">
            <div class="form-group">
                <label>Email *</label>
                <input type="email" id="adminEmail" value="admin@jkkn.edu">
            </div>
            <div class="form-group">
                <label>Password *</label>
                <input type="password" id="adminPass">
            </div>
            <button class="btn btn-primary btn-lg" style="width:100%;margin-top:1rem" onclick="loginAdmin()">
                üîê Admin Login
            </button>
        </div>
    </div>
</div>

<!-- ASSESSMENT -->
<div id="assessmentPage" class="hidden">
    <div class="assessment-layout">
        <aside class="sidebar">
            <div>
                <div style="color:#666;font-size:0.85rem">Your Question</div>
                <div class="q-badge" id="qBadge">-</div>
            </div>
            
            <div class="timer-box">
                <div style="color:#666;font-size:0.85rem">‚è±Ô∏è Time</div>
                <div class="timer" id="timer">00:00:00</div>
            </div>
            
            <div class="checklist">
                <h4>‚úÖ Checklist</h4>
                <div id="checklistItems"></div>
            </div>
            
            <div style="margin-top:0.8rem;background:#fff5f0;padding:0.8rem;border-radius:8px;text-align:center">
                <div style="font-size:0.8rem;color:#666">Total Marks</div>
                <div style="font-size:1.5rem;font-weight:700;color:#FF6B35">100</div>
            </div>
        </aside>

        <main class="main-content">
            <div class="scenario-box">
                <h2 id="qTitle">Loading...</h2>
                <div id="qScenario" style="color:#333;line-height:1.8"></div>
            </div>

            <div id="tasksArea"></div>

            <div class="submit-row">
                <div class="save-status" id="saveStatus">üí° Complete your work and submit</div>
                <div class="button-group">
                    <button class="btn btn-success btn-lg" onclick="saveWork()">
                        üíæ Save Progress
                    </button>
                    <button id="finalSubmitBtn" onclick="finalSubmit()">
                        üöÄ FINAL SUBMIT
                    </button>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboardPage" class="hidden">
    <div class="container">
        <h2 style="margin-bottom:1.5rem;color:#003D5B">üìä Dashboard <span style="font-size:0.9rem;color:#28a745">(Real-time Cloud Data)</span></h2>
        
        <div class="stats-grid">
            <div class="stat-card"><h4>Total</h4><div class="value" id="statTotal">0</div></div>
            <div class="stat-card"><h4>Average</h4><div class="value" id="statAvg">0%</div></div>
            <div class="stat-card"><h4>Submitted</h4><div class="value" id="statSubmitted">0</div></div>
            <div class="stat-card"><h4>Passed (‚â•40)</h4><div class="value" id="statPassed">0</div></div>
        </div>
        
        <div class="filters">
            <select id="filterDept" onchange="loadDashboard()">
                <option value="">All Departments</option>
                <option value="CSE/IT">CSE/IT</option>
                <option value="ECE">ECE</option>
                <option value="EEE">EEE</option>
                <option value="MECH">MECH</option>
            </select>
            <select id="filterStatus" onchange="loadDashboard()">
                <option value="">All Status</option>
                <option value="submitted">Submitted</option>
                <option value="saved">In Progress</option>
                <option value="pending_review">‚è≥ Pending Review</option>
            </select>
            <button class="btn btn-secondary" onclick="loadDashboard()">üîÑ Refresh</button>
            <button class="btn btn-secondary" onclick="exportExcel()">üì• Export Excel</button>
        </div>
        
        <div id="tableContainer">
            <div class="loading"><div class="spinner"></div><p>Loading submissions...</p></div>
        </div>
    </div>
</div>

<!-- View Modal -->
<div class="modal" id="viewModal" onclick="event.target===this && this.classList.remove('active')">
    <div class="modal-box">
        <div class="modal-header">
            <h3>üìÑ Submission Details</h3>
            <button class="modal-close" onclick="document.getElementById('viewModal').classList.remove('active')">&times;</button>
        </div>
        <div id="viewContent"></div>
    </div>
</div>

<!-- Grade Modal -->
<div class="modal" id="gradeModal" onclick="event.target===this && this.classList.remove('active')">
    <div class="modal-box">
        <div class="modal-header">
            <h3>‚úèÔ∏è Grade Submission</h3>
            <button class="modal-close" onclick="document.getElementById('gradeModal').classList.remove('active')">&times;</button>
        </div>
        <div id="gradeContent"></div>
    </div>
</div>

<script>
// =====================================================
// SUPABASE REST API CONFIG
// =====================================================
const SUPABASE_URL = 'https://yrwbeperjwcaylnixdxm.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlyd2JlcGVyandjYXlsbml4ZHhtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNTcwNjEsImV4cCI6MjA4MzYzMzA2MX0.0hVzidXvnZ03C5Lj7XM9egpbbGFS5IiiOpDaVYAxYeM';

// Direct REST API helper
async function supabaseRequest(endpoint, method = 'GET', body = null) {
    const options = {
        method,
        headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': method === 'POST' ? 'return=representation' : 'return=minimal'
        }
    };
    
    if (body) {
        options.body = JSON.stringify(body);
    }
    
    const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, options);
    
    if (!response.ok) {
        const error = await response.text();
        throw new Error(error);
    }
    
    const text = await response.text();
    return text ? JSON.parse(text) : null;
}

// Test connection
async function testConnection() {
    console.log('Testing Supabase connection...');
    try {
        const data = await supabaseRequest('submissions?select=id&limit=1');
        console.log('‚úÖ Connection successful:', data);
        
        document.getElementById('dbStatus').textContent = 'üü¢ Cloud Connected';
        document.getElementById('dbStatus').className = 'db-status db-online';
        document.getElementById('cloudStatus').textContent = '‚òÅÔ∏è Cloud Database Connected';
        document.getElementById('cloudStatus').style.color = '#28a745';
        return true;
    } catch (err) {
        console.error('Connection failed:', err.message);
        document.getElementById('dbStatus').textContent = 'üî¥ Offline';
        document.getElementById('dbStatus').className = 'db-status db-offline';
        document.getElementById('cloudStatus').textContent = '‚ö†Ô∏è Using offline mode';
        document.getElementById('cloudStatus').style.color = '#dc3545';
        return false;
    }
}

// =====================================================
// ANSWER KEYS - Unique validation for each question
// =====================================================
const ANSWER_KEYS = {
    // CSE Questions (80) - MCP Server Implementation
    "CSE_01": { title: "E-Commerce Customer Support MCP", requiredTools: ["orderLookup", "returnProcess", "paymentVerify", "customerQuery", "trackOrder"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "order", "return", "payment", "customer", "query"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["getOrderStatus", "processReturn", "verifyPayment", "handleQuery"] },
    "CSE_02": { title: "Banking Chatbot System", requiredTools: ["balanceInquiry", "transactionHistory", "cardServices", "loanInfo", "fraudReport"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "balance", "transaction", "account", "secure", "auth"], requiredPatterns: ["try", "catch", "if", "return", "async", "await", "const", "let"], minCodeLength: 800, expectedFunctions: ["getBalance", "getTransactions", "reportFraud", "authenticate"] },
    "CSE_03": { title: "Healthcare Appointment Scheduler", requiredTools: ["scheduleAppointment", "cancelAppointment", "getDoctorAvailability", "patientRouting", "sendReminder"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "appointment", "doctor", "patient", "schedule", "department"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["bookSlot", "checkAvailability", "cancelBooking", "sendNotification"] },
    "CSE_04": { title: "Real Estate Property Finder", requiredTools: ["searchProperties", "getPropertyDetails", "comparePrices", "scheduleTour", "getPriceTrends"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "property", "location", "price", "budget", "amenities"], requiredPatterns: ["try", "catch", "if", "return", "filter", "map"], minCodeLength: 800, expectedFunctions: ["searchByLocation", "filterByBudget", "getDetails", "bookTour"] },
    "CSE_05": { title: "HR Recruitment Assistant", requiredTools: ["parseResume", "matchJobs", "scoreCandidate", "scheduleInterview", "getApplicationStatus"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "resume", "candidate", "job", "skill", "interview"], requiredPatterns: ["try", "catch", "if", "return", "async", "await", "score"], minCodeLength: 800, expectedFunctions: ["extractSkills", "matchProfile", "rankCandidates", "sendInvite"] },
    "CSE_06": { title: "Restaurant Order Management", requiredTools: ["createOrder", "updateOrderStatus", "getKitchenCapacity", "estimateDelivery", "syncMenu"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "order", "kitchen", "delivery", "menu", "restaurant"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["placeOrder", "trackOrder", "updateStatus", "calculateETA"] },
    "CSE_07": { title: "Travel Booking Concierge", requiredTools: ["searchFlights", "bookHotel", "suggestActivities", "createItinerary", "optimizeBudget"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "flight", "hotel", "travel", "booking", "itinerary"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["findFlights", "compareHotels", "planTrip", "calculateCost"] },
    "CSE_08": { title: "Insurance Claim Processor", requiredTools: ["submitClaim", "verifyDocuments", "detectFraud", "calculateSettlement", "getClaimStatus"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "claim", "insurance", "document", "fraud", "settlement"], requiredPatterns: ["try", "catch", "if", "return", "async", "await", "validate"], minCodeLength: 800, expectedFunctions: ["processClaim", "validateDocs", "checkFraud", "approveClaim"] },
    "CSE_09": { title: "Course Recommender System", requiredTools: ["assessSkills", "recommendCourses", "createLearningPath", "trackProgress", "suggestCertification"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "course", "skill", "learning", "recommendation", "career"], requiredPatterns: ["try", "catch", "if", "return", "async", "await", "filter"], minCodeLength: 800, expectedFunctions: ["getRecommendations", "buildPath", "updateProgress", "matchGoals"] },
    "CSE_10": { title: "Inventory Management Assistant", requiredTools: ["checkStock", "forecastDemand", "createReorder", "identifyDeadStock", "manageSupplier"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "inventory", "stock", "demand", "reorder", "supplier"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["getStockLevel", "predictDemand", "placeOrder", "alertLowStock"] },
    "CSE_11": { title: "Log Analysis System", requiredTools: ["parseLog", "detectPattern", "findAnomaly", "generateAlert", "suggestRootCause"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "log", "error", "pattern", "anomaly", "alert"], requiredPatterns: ["try", "catch", "if", "return", "async", "await", "regex", "match"], minCodeLength: 800, expectedFunctions: ["analyzeLogs", "detectErrors", "findPatterns", "createAlert"] },
    "CSE_12": { title: "Social Media Analytics", requiredTools: ["analyzeSentiment", "trackEngagement", "compareCompetitors", "recommendContent", "generateReport"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "sentiment", "engagement", "social", "analytics", "content"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["getSentiment", "calculateEngagement", "trackMetrics", "suggestPosts"] },
    "CSE_13": { title: "Financial Report Analyzer", requiredTools: ["parseReport", "extractMetrics", "analyzetrends", "compareIndustry", "generateSummary"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "financial", "revenue", "profit", "expense", "report"], requiredPatterns: ["try", "catch", "if", "return", "async", "await", "calculate"], minCodeLength: 800, expectedFunctions: ["extractRevenue", "analyzeProfitability", "compareBenchmark", "createSummary"] },
    "CSE_14": { title: "Code Review Assistant", requiredTools: ["checkStyle", "detectBugs", "findVulnerabilities", "suggestImprovements", "generateReport"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "code", "review", "bug", "security", "style"], requiredPatterns: ["try", "catch", "if", "return", "async", "await", "lint"], minCodeLength: 800, expectedFunctions: ["analyzeCode", "findBugs", "checkSecurity", "suggestFix"] },
    "CSE_15": { title: "Email Campaign Manager", requiredTools: ["createCampaign", "segmentAudience", "scheduleEmail", "trackPerformance", "runABTest"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "email", "campaign", "segment", "subscriber", "open"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["sendCampaign", "createSegment", "trackOpens", "analyzeClicks"] },
    "CSE_16": { title: "API Gateway Monitor", requiredTools: ["checkHealth", "trackLatency", "monitorErrors", "enforceRateLimit", "generateMetrics"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "api", "endpoint", "latency", "error", "rate"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["getHealth", "measureLatency", "trackErrors", "limitRate"] },
    "CSE_17": { title: "Document Q&A System", requiredTools: ["indexDocument", "searchContent", "answerQuestion", "findGaps", "getCitations"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "document", "search", "answer", "knowledge", "query"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["indexDocs", "searchKnowledge", "generateAnswer", "provideCitation"] },
    "CSE_18": { title: "Expense Report Processor", requiredTools: ["submitExpense", "scanReceipt", "checkPolicy", "routeApproval", "trackReimbursement"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "expense", "receipt", "policy", "approval", "reimburse"], requiredPatterns: ["try", "catch", "if", "return", "async", "await", "validate"], minCodeLength: 800, expectedFunctions: ["processExpense", "validateReceipt", "checkCompliance", "submitForApproval"] },
    "CSE_19": { title: "Meeting Scheduler Agent", requiredTools: ["findAvailability", "bookMeeting", "sendInvite", "bookRoom", "resolveConflict"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "meeting", "calendar", "room", "invite", "schedule"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["checkCalendar", "createMeeting", "reserveRoom", "notifyAttendees"] },
    "CSE_20": { title: "Feedback Analysis System", requiredTools: ["collectFeedback", "analyzeSentiment", "extractTopics", "identifyTrends", "suggestResponse"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "feedback", "review", "sentiment", "topic", "trend"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["processFeedback", "getSentiment", "findTopics", "generateResponse"] },
    "CSE_21": { title: "CRM Integration Hub", requiredTools: ["syncContacts", "syncDeals", "detectDuplicates", "mergeRecords", "getUnifiedView"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "crm", "contact", "deal", "sync", "salesforce"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["importContacts", "exportDeals", "findDuplicates", "unifyData"] },
    "CSE_22": { title: "DevOps Pipeline Orchestrator", requiredTools: ["triggerBuild", "deployApp", "runTests", "rollbackDeploy", "getStatus"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "build", "deploy", "pipeline", "ci", "cd"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["startPipeline", "executeDeploy", "checkTests", "performRollback"] },
    "CSE_23": { title: "Multi-Cloud Resource Manager", requiredTools: ["listResources", "optimizeCost", "provisionInstance", "checkCompliance", "generateReport"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "cloud", "aws", "azure", "resource", "cost"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["getResources", "analyzeCost", "createInstance", "auditCompliance"] },
    "CSE_24": { title: "Payment Gateway Aggregator", requiredTools: ["processPayment", "initiateRefund", "manageSubscription", "reconcileTransactions", "getPaymentStatus"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "payment", "refund", "subscription", "transaction", "gateway"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["chargeCard", "refundPayment", "createSubscription", "verifyTransaction"] },
    "CSE_25": { title: "Notification Hub System", requiredTools: ["sendEmail", "sendSMS", "sendPush", "manageTemplate", "trackDelivery"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "notification", "email", "sms", "push", "template"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["sendNotification", "createTemplate", "checkDelivery", "managePreferences"] },
    "CSE_26": { title: "Warehouse Management System", requiredTools: ["trackInventory", "optimizePicking", "processReceiving", "manageShipping", "locateItem"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "warehouse", "inventory", "pick", "ship", "receive"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["findItem", "createPickList", "processShipment", "updateInventory"] },
    "CSE_27": { title: "Content Management System", requiredTools: ["createContent", "submitForApproval", "publishContent", "schedulePost", "optimizeSEO"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "content", "publish", "approval", "seo", "schedule"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["saveContent", "reviewContent", "publishPost", "analyzeSEO"] },
    "CSE_28": { title: "Fleet Management System", requiredTools: ["trackVehicle", "optimizeRoute", "scheduleMaintenance", "assignDriver", "generateReport"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "fleet", "vehicle", "route", "driver", "gps"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["getLocation", "planRoute", "scheduleService", "trackDriver"] },
    "CSE_29": { title: "Event Management Platform", requiredTools: ["createEvent", "registerAttendee", "issueTicket", "checkIn", "manageSpeaker"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "event", "registration", "ticket", "attendee", "speaker"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["setupEvent", "processRegistration", "generateTicket", "recordAttendance"] },
    "CSE_30": { title: "Subscription Management System", requiredTools: ["createSubscription", "manageBilling", "trackUsage", "predictChurn", "handleRenewal"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "subscription", "billing", "plan", "churn", "renewal"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["startSubscription", "processBilling", "checkUsage", "cancelSubscription"] },
    "CSE_31": { title: "Image Analysis Pipeline", requiredTools: ["detectObjects", "classifyImage", "extractText", "assessQuality", "processsBatch"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "image", "detect", "classify", "ocr", "quality"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["analyzeImage", "findObjects", "readText", "checkQuality"] },
    "CSE_32": { title: "NLP Processing Hub", requiredTools: ["extractEntities", "summarizeText", "translateContent", "analyzeSentiment", "classifyIntent"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "nlp", "entity", "summarize", "translate", "sentiment"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["processText", "findEntities", "createSummary", "detectLanguage"] },
    "CSE_33": { title: "Recommendation Engine", requiredTools: ["getRecommendations", "trackInteraction", "updatePreferences", "runABTest", "explainRecommendation"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "recommend", "user", "item", "collaborative", "content"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["generateRecommendations", "recordClick", "updateModel", "personalizeResults"] },
    "CSE_34": { title: "Fraud Detection System", requiredTools: ["scoreTransaction", "detectPattern", "createAlert", "manageCase", "updateModel"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "fraud", "transaction", "score", "alert", "pattern"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["analyzeTransaction", "calculateRisk", "flagFraud", "investigateCase"] },
    "CSE_35": { title: "Chatbot Training Pipeline", requiredTools: ["classifyIntent", "extractEntities", "manageFlow", "trainModel", "evaluatePerformance"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "chatbot", "intent", "entity", "train", "conversation"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["detectIntent", "parseEntities", "generateResponse", "improveModel"] },
    "CSE_36": { title: "Predictive Analytics Platform", requiredTools: ["ingestData", "trainModel", "servePrediction", "monitorDrift", "explainPrediction"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "predict", "model", "train", "data", "analytics"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["loadData", "buildModel", "makePrediction", "trackAccuracy"] },
    "CSE_37": { title: "Speech Processing Service", requiredTools: ["transcribeSpeech", "generateSpeech", "identifySpeaker", "detectEmotion", "translateSpeech"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "speech", "audio", "transcribe", "voice", "emotion"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["convertToText", "convertToSpeech", "recognizeSpeaker", "analyzeEmotion"] },
    "CSE_38": { title: "Knowledge Graph Query System", requiredTools: ["linkEntities", "extractRelations", "queryGraph", "inferFacts", "visualizeGraph"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "graph", "entity", "relation", "knowledge", "query"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["findEntity", "getRelations", "runQuery", "discoverFacts"] },
    "CSE_39": { title: "Anomaly Detection Service", requiredTools: ["detectAnomaly", "analyzeTimeSeries", "createAlert", "adjustSeason", "findRootCause"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "anomaly", "timeseries", "detect", "alert", "threshold"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["analyzeData", "findAnomalies", "sendAlert", "investigateCause"] },
    "CSE_40": { title: "Data Quality Monitor", requiredTools: ["validateSchema", "checkCompleteness", "enforceRules", "scoreQuality", "trackLineage"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "data", "quality", "schema", "validation", "completeness"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["checkSchema", "validateData", "measureQuality", "reportIssues"] },
    "CSE_41": { title: "Task Automation Engine", requiredTools: ["defineWorkflow", "setTrigger", "executeAction", "handleError", "scheduleTask"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "workflow", "automation", "trigger", "task", "execute"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["createWorkflow", "runTask", "handleFailure", "logExecution"] },
    "CSE_42": { title: "Form Processing System", requiredTools: ["detectForm", "extractFields", "validateData", "mapToSchema", "exportResults"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "form", "field", "extract", "ocr", "document"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["parseForm", "readFields", "validateInput", "saveData"] },
    "CSE_43": { title: "Test Automation Framework", requiredTools: ["manageTestCase", "runTests", "analyzeResults", "reportCoverage", "trackRegression"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "test", "automation", "coverage", "result", "regression"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["executeTests", "collectResults", "generateReport", "trackBugs"] },
    "CSE_44": { title: "Compliance Monitoring System", requiredTools: ["manageRules", "monitorTransactions", "generateAlert", "createReport", "trackAudit"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "compliance", "rule", "monitor", "audit", "regulatory"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["checkCompliance", "detectViolation", "fileReport", "maintainAudit"] },
    "CSE_45": { title: "Contract Analysis System", requiredTools: ["extractClauses", "identifyRisks", "compareContracts", "trackObligations", "manageTemplates"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "contract", "clause", "risk", "legal", "obligation"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["parseContract", "findClauses", "assessRisk", "trackDeadlines"] },
    "CSE_46": { title: "Infrastructure as Code Manager", requiredTools: ["manageTemplate", "detectDrift", "estimateCost", "validateConfig", "deployInfra"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "terraform", "infrastructure", "deploy", "config", "drift"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["applyTemplate", "checkDrift", "calculateCost", "validateSyntax"] },
    "CSE_47": { title: "Database Migration Assistant", requiredTools: ["analyzeSchema", "mapData", "executeMigration", "validateMigration", "rollbackChanges"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "database", "migration", "schema", "data", "rollback"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["compareSchemas", "migrateData", "verifyIntegrity", "revertChanges"] },
    "CSE_48": { title: "Secret Management System", requiredTools: ["storeSecret", "rotateSecret", "manageAccess", "auditUsage", "generateSecret"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "secret", "vault", "rotate", "access", "encrypt"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["saveSecret", "getSecret", "rotateCredential", "logAccess"] },
    "CSE_49": { title: "Feature Flag Manager", requiredTools: ["createFlag", "setTargeting", "rolloutFeature", "trackAnalytics", "killSwitch"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "feature", "flag", "rollout", "targeting", "toggle"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["enableFlag", "disableFlag", "setRules", "measureImpact"] },
    "CSE_50": { title: "Incident Management System", requiredTools: ["aggregateAlerts", "routeOnCall", "escalateIncident", "runRunbook", "trackSLA"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "incident", "alert", "oncall", "escalate", "runbook"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["createIncident", "notifyTeam", "executeRunbook", "resolveIncident"] },
    "CSE_51": { title: "Product Catalog Manager", requiredTools: ["manageCategory", "handleAttributes", "optimizeSearch", "bulkUpdate", "syncInventory"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "product", "catalog", "category", "attribute", "search"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["addProduct", "updateCategory", "indexSearch", "processsBulk"] },
    "CSE_52": { title: "Shopping Cart Service", requiredTools: ["addToCart", "updateQuantity", "applyCoupon", "calculateTotal", "checkInventory"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "cart", "item", "quantity", "price", "coupon"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["addItem", "removeItem", "getTotal", "validateCoupon"] },
    "CSE_53": { title: "Order Processing Pipeline", requiredTools: ["validateOrder", "capturePayment", "routeFulfillment", "trackStatus", "handleReturn"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "order", "payment", "fulfillment", "status", "shipping"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["createOrder", "processPayment", "shipOrder", "updateStatus"] },
    "CSE_54": { title: "Pricing Engine Service", requiredTools: ["calculatePrice", "trackCompetitor", "managePromotion", "optimizeMargin", "applyDiscount"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "price", "discount", "margin", "competitor", "dynamic"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["getPrice", "setDiscount", "analyzeCompetitor", "optimizePrice"] },
    "CSE_55": { title: "Review Management System", requiredTools: ["collectReview", "moderateContent", "analyzeSentiment", "generateResponse", "detectFake"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "review", "rating", "sentiment", "moderate", "fake"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["submitReview", "approveReview", "respondToReview", "aggregateRatings"] },
    "CSE_56": { title: "Seller Onboarding Platform", requiredTools: ["verifyKYC", "setupCatalog", "provideTraining", "trackPerformance", "managePayout"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "seller", "kyc", "onboard", "catalog", "payout"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["registerSeller", "verifyDocuments", "setupStore", "processPayout"] },
    "CSE_57": { title: "Promotion Engine", requiredTools: ["createCampaign", "setTargeting", "controlBudget", "trackPerformance", "personalizeOffer"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "promotion", "campaign", "discount", "target", "offer"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["launchCampaign", "applyPromotion", "measureROI", "optimizeBudget"] },
    "CSE_58": { title: "Wishlist Management", requiredTools: ["addToWishlist", "shareList", "setPriceAlert", "notifyStock", "moveToCart"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "wishlist", "item", "alert", "share", "notify"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["saveItem", "removeItem", "createAlert", "sendNotification"] },
    "CSE_59": { title: "Returns Processor", requiredTools: ["initiateReturn", "approveReturn", "processRefund", "inspectQuality", "restockItem"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "return", "refund", "quality", "restock", "approve"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["createReturn", "validateReturn", "issueRefund", "updateInventory"] },
    "CSE_60": { title: "Loyalty Program Manager", requiredTools: ["earnPoints", "redeemReward", "manageTier", "integratePartner", "trackEngagement"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "loyalty", "points", "reward", "tier", "member"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["addPoints", "claimReward", "upgradeTier", "getBalance"] },
    "CSE_61": { title: "Loan Origination System", requiredTools: ["submitApplication", "scoreCredit", "verifyDocuments", "approveWorkflow", "disburseFunds"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "loan", "credit", "application", "approve", "disburse"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["processApplication", "calculateScore", "reviewDocs", "fundLoan"] },
    "CSE_62": { title: "Investment Portfolio Tracker", requiredTools: ["trackHoldings", "calculatePerformance", "suggestRebalance", "optimizeTax", "compareBenchmark"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "portfolio", "investment", "return", "holding", "performance"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["getHoldings", "calculateReturns", "rebalancePortfolio", "generateReport"] },
    "CSE_63": { title: "Tax Calculation Engine", requiredTools: ["computeIncome", "optimizeDeductions", "calculateAdvance", "assistFiling", "compareRegimes"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "tax", "income", "deduction", "filing", "regime"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["calculateTax", "findDeductions", "estimateAdvance", "prepareReturn"] },
    "CSE_64": { title: "Bill Payment Aggregator", requiredTools: ["fetchBills", "processPayment", "setupAutoPay", "sendReminder", "getHistory"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "bill", "payment", "biller", "autopay", "due"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["getBills", "payBill", "schedulePayment", "trackPayments"] },
    "CSE_65": { title: "Mutual Fund SIP Manager", requiredTools: ["selectFund", "setupSIP", "modifySIP", "trackPerformance", "planGoal"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "sip", "fund", "mutual", "nav", "investment"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["startSIP", "cancelSIP", "comparesFunds", "calculateReturns"] },
    "CSE_66": { title: "Credit Score Monitor", requiredTools: ["fetchScore", "analyzeFactors", "suggestImprovement", "createAlert", "disputeError"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "credit", "score", "factor", "bureau", "dispute"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["getScore", "analyzeFactors", "trackChanges", "fileDispute"] },
    "CSE_67": { title: "Expense Splitter App", requiredTools: ["createGroup", "logExpense", "calculateSplit", "settleBalance", "generateSummary"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "expense", "split", "group", "balance", "settle"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["addExpense", "splitAmount", "getBalances", "recordSettlement"] },
    "CSE_68": { title: "Stock Trading Assistant", requiredTools: ["analyzeMarket", "manageAlerts", "placeOrder", "trackPortfolio", "getResearch"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "stock", "trade", "market", "order", "portfolio"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["getQuote", "createAlert", "executeTrade", "analyzeStock"] },
    "CSE_69": { title: "Insurance Comparison Engine", requiredTools: ["aggregateQuotes", "compareFeatures", "recommendPlan", "analyzeHistory", "renewPolicy"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "insurance", "quote", "premium", "coverage", "compare"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["getQuotes", "comparePlans", "selectPolicy", "calculatePremium"] },
    "CSE_70": { title: "EMI Calculator and Tracker", requiredTools: ["compareLoan", "trackPayment", "analyzePrepay", "suggestRefinance", "calculateImpact"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "emi", "loan", "interest", "prepay", "refinance"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["calculateEMI", "trackEMI", "simulatePrepay", "compareRefinance"] },
    "CSE_71": { title: "Restaurant Table Reservation", requiredTools: ["checkAvailability", "bookTable", "manageWaitlist", "recordPreferences", "sendConfirmation"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "reservation", "table", "booking", "restaurant", "guest"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["findTable", "makeReservation", "cancelBooking", "updatePreferences"] },
    "CSE_72": { title: "Gym Membership Manager", requiredTools: ["manageMember", "bookClass", "assignTrainer", "trackAttendance", "analyzeProgress"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "member", "gym", "class", "trainer", "fitness"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["registerMember", "reserveClass", "markAttendance", "generateReport"] },
    "CSE_73": { title: "Library Management System", requiredTools: ["searchCatalog", "borrowBook", "returnBook", "manageFines", "recommendBooks"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "library", "book", "borrow", "return", "catalog"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["findBook", "checkoutBook", "checkinBook", "calculateFine"] },
    "CSE_74": { title: "Parking Management System", requiredTools: ["checkSpots", "reserveSpot", "processPayment", "manageViolations", "generateAnalytics"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "parking", "spot", "vehicle", "reservation", "payment"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["findSpot", "bookParking", "releaseSpot", "chargeUser"] },
    "CSE_75": { title: "Movie Ticket Booking", requiredTools: ["listShows", "selectSeats", "processBooking", "applyOffers", "handleCancellation"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "movie", "ticket", "seat", "booking", "show"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["getMovies", "bookSeats", "confirmBooking", "cancelTicket"] },
    "CSE_76": { title: "Laundry Service Platform", requiredTools: ["createOrder", "schedulePickup", "trackProgress", "manageDelivery", "handleComplaints"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "laundry", "order", "pickup", "delivery", "service"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["placeOrder", "scheduleCollection", "updateStatus", "completeDelivery"] },
    "CSE_77": { title: "Pet Care Service Manager", requiredTools: ["bookService", "managePetProfile", "trackVetRecords", "sendReminders", "findEmergency"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "pet", "service", "vet", "grooming", "booking"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["registerPet", "bookAppointment", "updateRecords", "alertOwner"] },
    "CSE_78": { title: "Home Services Marketplace", requiredTools: ["listServices", "bookService", "manageProvider", "collectReviews", "handleDispute"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "service", "provider", "booking", "home", "review"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["findService", "requestBooking", "assignProvider", "rateService"] },
    "CSE_79": { title: "Tutor Matching Platform", requiredTools: ["matchTutor", "scheduleSession", "trackProgress", "processPayment", "collectFeedback"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "tutor", "student", "session", "subject", "learning"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["findTutor", "bookSession", "recordProgress", "submitFeedback"] },
    "CSE_80": { title: "Volunteer Management System", requiredTools: ["registerVolunteer", "matchOpportunity", "scheduleShift", "trackHours", "recognizeContribution"], requiredKeywords: ["MCPServer", "server.tool", "async", "await", "volunteer", "opportunity", "hours", "event", "nonprofit"], requiredPatterns: ["try", "catch", "if", "return", "async", "await"], minCodeLength: 800, expectedFunctions: ["signupVolunteer", "assignTask", "logHours", "generateCertificate"] },
    
    // ECE Questions (25) - IoT/Embedded Systems
    "ECE_01": { title: "Smart Irrigation Controller", requiredComponents: ["soil moisture sensor", "esp32", "relay", "pump", "solar"], requiredKeywords: ["moisture", "threshold", "irrigation", "pump", "sensor", "wifi", "mqtt", "water"], requiredSections: ["component", "working", "circuit", "algorithm", "power", "cost"], minDescLength: 400 },
    "ECE_02": { title: "Crop Disease Detection Camera", requiredComponents: ["esp32-cam", "camera", "edge ai", "tinyml", "battery"], requiredKeywords: ["disease", "detection", "camera", "image", "classification", "ai", "model", "leaf"], requiredSections: ["component", "working", "algorithm", "training", "deployment", "power"], minDescLength: 400 },
    "ECE_03": { title: "Livestock Health Monitoring Collar", requiredComponents: ["temperature sensor", "accelerometer", "gps", "lora", "battery"], requiredKeywords: ["health", "temperature", "activity", "collar", "animal", "monitoring", "alert"], requiredSections: ["component", "working", "communication", "power", "algorithm", "cost"], minDescLength: 400 },
    "ECE_04": { title: "Greenhouse Climate Controller", requiredComponents: ["dht22", "relay", "fan", "heater", "arduino"], requiredKeywords: ["temperature", "humidity", "greenhouse", "ventilation", "control", "climate"], requiredSections: ["component", "working", "control", "algorithm", "deployment", "cost"], minDescLength: 400 },
    "ECE_05": { title: "Fish Pond Water Quality Monitor", requiredComponents: ["ph sensor", "do sensor", "temperature", "esp32", "aerator"], requiredKeywords: ["water", "quality", "ph", "oxygen", "pond", "fish", "monitoring", "alert"], requiredSections: ["component", "working", "sensor", "algorithm", "alert", "cost"], minDescLength: 400 },
    "ECE_06": { title: "Voice-Controlled Home Automation", requiredComponents: ["microphone", "esp32", "relay", "speaker", "led"], requiredKeywords: ["voice", "command", "home", "automation", "control", "light", "fan", "recognition"], requiredSections: ["component", "working", "voice", "algorithm", "interface", "cost"], minDescLength: 400 },
    "ECE_07": { title: "Smart Door Lock with Face Recognition", requiredComponents: ["camera", "servo", "esp32", "lcd", "keypad"], requiredKeywords: ["face", "recognition", "door", "lock", "security", "access", "servo"], requiredSections: ["component", "working", "algorithm", "security", "interface", "cost"], minDescLength: 400 },
    "ECE_08": { title: "Elderly Fall Detection Wearable", requiredComponents: ["accelerometer", "gps", "gsm", "battery", "vibration"], requiredKeywords: ["fall", "detection", "elderly", "alert", "accelerometer", "emergency", "wearable"], requiredSections: ["component", "working", "algorithm", "alert", "battery", "cost"], minDescLength: 400 },
    "ECE_09": { title: "Smart Parking Guidance System", requiredComponents: ["ultrasonic", "led", "esp32", "display", "ir sensor"], requiredKeywords: ["parking", "slot", "available", "guidance", "sensor", "display", "indicator"], requiredSections: ["component", "working", "detection", "display", "communication", "cost"], minDescLength: 400 },
    "ECE_10": { title: "Air Quality Monitor with Health Alerts", requiredComponents: ["mq135", "pm sensor", "dht22", "oled", "buzzer"], requiredKeywords: ["air", "quality", "pm2.5", "aqi", "health", "alert", "pollution"], requiredSections: ["component", "working", "sensor", "calculation", "alert", "cost"], minDescLength: 400 },
    "ECE_11": { title: "CNC Machine Vibration Monitor", requiredComponents: ["accelerometer", "esp32", "fft", "wifi", "display"], requiredKeywords: ["vibration", "cnc", "machine", "fft", "frequency", "bearing", "maintenance"], requiredSections: ["component", "working", "analysis", "threshold", "alert", "cost"], minDescLength: 400 },
    "ECE_12": { title: "Cold Chain Temperature Logger", requiredComponents: ["ds18b20", "gps", "sd card", "gsm", "battery"], requiredKeywords: ["temperature", "cold chain", "vaccine", "logger", "gps", "alert", "storage"], requiredSections: ["component", "working", "logging", "alert", "communication", "cost"], minDescLength: 400 },
    "ECE_13": { title: "Conveyor Belt Speed Monitor", requiredComponents: ["encoder", "current sensor", "esp32", "display", "relay"], requiredKeywords: ["conveyor", "speed", "belt", "slip", "motor", "current", "monitoring"], requiredSections: ["component", "working", "measurement", "detection", "alert", "cost"], minDescLength: 400 },
    "ECE_14": { title: "Compressed Air Leak Detector", requiredComponents: ["ultrasonic mic", "amplifier", "arduino", "display", "buzzer"], requiredKeywords: ["leak", "ultrasonic", "compressed", "air", "detection", "frequency", "cfm"], requiredSections: ["component", "working", "detection", "calculation", "cost savings", "deployment"], minDescLength: 400 },
    "ECE_15": { title: "Industrial Safety Helmet", requiredComponents: ["uwb", "accelerometer", "vibration motor", "battery", "ble"], requiredKeywords: ["safety", "helmet", "proximity", "detection", "fall", "alert", "industrial"], requiredSections: ["component", "working", "detection", "alert", "communication", "cost"], minDescLength: 400 },
    "ECE_16": { title: "Smart Baby Monitor", requiredComponents: ["microphone", "dht22", "camera", "speaker", "wifi"], requiredKeywords: ["baby", "monitor", "cry", "temperature", "breathing", "alert", "classification"], requiredSections: ["component", "working", "detection", "classification", "alert", "cost"], minDescLength: 400 },
    "ECE_17": { title: "GPS Pet Tracker Collar", requiredComponents: ["gps", "gsm", "battery", "accelerometer", "buzzer"], requiredKeywords: ["pet", "tracker", "gps", "geofence", "activity", "battery", "collar"], requiredSections: ["component", "working", "tracking", "geofence", "battery", "cost"], minDescLength: 400 },
    "ECE_18": { title: "Smart Water Bottle", requiredComponents: ["flow sensor", "uv led", "temperature", "ble", "battery"], requiredKeywords: ["water", "bottle", "hydration", "tracking", "uv", "sterilization", "reminder"], requiredSections: ["component", "working", "measurement", "sterilization", "app", "cost"], minDescLength: 400 },
    "ECE_19": { title: "Smart Motorcycle Helmet", requiredComponents: ["bone conduction", "accelerometer", "gps", "battery", "ble"], requiredKeywords: ["helmet", "motorcycle", "navigation", "brake", "light", "crash", "detection"], requiredSections: ["component", "working", "audio", "detection", "alert", "cost"], minDescLength: 400 },
    "ECE_20": { title: "Smart Plant Care System", requiredComponents: ["soil moisture", "light sensor", "pump", "esp32", "reservoir"], requiredKeywords: ["plant", "watering", "moisture", "light", "automatic", "care", "indoor"], requiredSections: ["component", "working", "sensing", "watering", "algorithm", "cost"], minDescLength: 400 },
    "ECE_21": { title: "Drone Crop Spraying Controller", requiredComponents: ["gps", "flow sensor", "pump", "flight controller", "tank"], requiredKeywords: ["drone", "spraying", "crop", "gps", "flow", "rate", "coverage"], requiredSections: ["component", "working", "gps", "spraying", "control", "cost"], minDescLength: 400 },
    "ECE_22": { title: "Assistive Device for Visually Impaired", requiredComponents: ["ultrasonic", "camera", "vibration", "bone conduction", "battery"], requiredKeywords: ["assistive", "blind", "obstacle", "detection", "navigation", "audio", "haptic"], requiredSections: ["component", "working", "detection", "feedback", "interface", "cost"], minDescLength: 400 },
    "ECE_23": { title: "Solar Panel Performance Optimizer", requiredComponents: ["current sensor", "voltage sensor", "esp32", "relay", "display"], requiredKeywords: ["solar", "panel", "power", "efficiency", "mppt", "monitoring", "string"], requiredSections: ["component", "working", "measurement", "optimization", "fault", "cost"], minDescLength: 400 },
    "ECE_24": { title: "Smart EV Charger", requiredComponents: ["relay", "current sensor", "energy meter", "esp32", "display"], requiredKeywords: ["ev", "charger", "electric", "vehicle", "energy", "scheduling", "safety"], requiredSections: ["component", "working", "safety", "metering", "scheduling", "cost"], minDescLength: 400 },
    "ECE_25": { title: "Industrial Noise Monitoring System", requiredComponents: ["microphone", "amplifier", "arduino", "display", "sd card"], requiredKeywords: ["noise", "decibel", "db", "industrial", "safety", "twa", "dosimeter"], requiredSections: ["component", "working", "measurement", "twa", "alert", "cost"], minDescLength: 400 },
    
    // EEE Questions (10) - Power Systems
    "EEE_01": { title: "Three-Phase Power Quality Analyzer", requiredComponents: ["ct", "pt", "adc", "esp32", "display"], requiredKeywords: ["power", "quality", "three-phase", "voltage", "current", "pf", "harmonic", "thd"], requiredSections: ["component", "working", "measurement", "calculation", "display", "cost"], minDescLength: 400 },
    "EEE_02": { title: "Solar Inverter Performance Monitor", requiredComponents: ["voltage sensor", "current sensor", "esp32", "wifi", "display"], requiredKeywords: ["solar", "inverter", "efficiency", "power", "dc", "ac", "monitoring", "generation"], requiredSections: ["component", "working", "measurement", "efficiency", "fault", "cost"], minDescLength: 400 },
    "EEE_03": { title: "Industrial Motor Health Monitor", requiredComponents: ["ct", "vibration sensor", "temperature", "esp32", "display"], requiredKeywords: ["motor", "health", "current", "vibration", "temperature", "maintenance", "prediction"], requiredSections: ["component", "working", "analysis", "prediction", "alert", "cost"], minDescLength: 400 },
    "EEE_04": { title: "Automatic Power Factor Correction", requiredComponents: ["ct", "relay", "capacitor", "arduino", "display"], requiredKeywords: ["power factor", "capacitor", "correction", "apfc", "reactive", "kvar", "penalty"], requiredSections: ["component", "working", "measurement", "switching", "control", "cost"], minDescLength: 400 },
    "EEE_05": { title: "Smart Energy Meter with Theft Detection", requiredComponents: ["ct", "voltage sensor", "esp32", "gsm", "lcd"], requiredKeywords: ["energy", "meter", "theft", "tamper", "billing", "smart", "gsm", "detection"], requiredSections: ["component", "working", "metering", "tamper", "communication", "cost"], minDescLength: 400 },
    "EEE_06": { title: "Battery Management System", requiredComponents: ["voltage sensor", "current sensor", "temperature", "mosfet", "mcu"], requiredKeywords: ["battery", "bms", "cell", "balancing", "soc", "soh", "lithium", "protection"], requiredSections: ["component", "working", "balancing", "protection", "soc", "cost"], minDescLength: 400 },
    "EEE_07": { title: "Maximum Demand Controller", requiredComponents: ["ct", "relay", "esp32", "display", "contactor"], requiredKeywords: ["demand", "maximum", "load", "shedding", "kva", "prediction", "penalty", "contract"], requiredSections: ["component", "working", "prediction", "shedding", "control", "cost"], minDescLength: 400 },
    "EEE_08": { title: "VFD Performance Optimizer", requiredComponents: ["ct", "voltage sensor", "esp32", "display", "modbus"], requiredKeywords: ["vfd", "drive", "motor", "efficiency", "speed", "energy", "optimization"], requiredSections: ["component", "working", "monitoring", "efficiency", "fault", "cost"], minDescLength: 400 },
    "EEE_09": { title: "Underground Cable Fault Locator", requiredComponents: ["pulse generator", "oscilloscope", "arduino", "display", "amplifier"], requiredKeywords: ["cable", "fault", "underground", "location", "tdr", "distance", "detection"], requiredSections: ["component", "working", "tdr", "measurement", "location", "cost"], minDescLength: 400 },
    "EEE_10": { title: "Smart Transformer Monitoring", requiredComponents: ["temperature sensor", "ct", "oil level", "gsm", "esp32"], requiredKeywords: ["transformer", "monitoring", "oil", "temperature", "loading", "life", "health"], requiredSections: ["component", "working", "monitoring", "prediction", "communication", "cost"], minDescLength: 400 },
    
    // MECH Questions (10) - Manufacturing/Automation
    "MECH_01": { title: "AI Visual Inspection for Casting Defects", requiredComponents: ["camera", "lighting", "conveyor", "reject mechanism", "plc"], requiredKeywords: ["visual", "inspection", "defect", "casting", "camera", "ai", "detection", "quality"], requiredSections: ["component", "working", "ai model", "lighting", "reject", "cost"], minDescLength: 400 },
    "MECH_02": { title: "CNC Spindle Bearing Predictive Maintenance", requiredComponents: ["accelerometer", "temperature", "esp32", "fft", "display"], requiredKeywords: ["spindle", "bearing", "vibration", "predictive", "maintenance", "fft", "failure"], requiredSections: ["component", "working", "analysis", "prediction", "alert", "cost"], minDescLength: 400 },
    "MECH_03": { title: "Collaborative Robot Pick-and-Place Cell", requiredComponents: ["cobot", "gripper", "camera", "safety sensor", "plc"], requiredKeywords: ["cobot", "robot", "pick", "place", "collaborative", "gripper", "vision", "safety"], requiredSections: ["component", "working", "programming", "safety", "cycle time", "cost"], minDescLength: 400 },
    "MECH_04": { title: "Compressed Air Leak Detection System", requiredComponents: ["ultrasonic mic", "amplifier", "display", "wifi", "mapping"], requiredKeywords: ["leak", "compressed", "air", "ultrasonic", "detection", "cfm", "cost", "energy"], requiredSections: ["component", "working", "detection", "quantification", "roi", "cost"], minDescLength: 400 },
    "MECH_05": { title: "Injection Molding Quality Prediction", requiredComponents: ["pressure sensor", "temperature sensor", "timer", "plc", "display"], requiredKeywords: ["injection", "molding", "quality", "pressure", "temperature", "prediction", "defect"], requiredSections: ["component", "working", "monitoring", "prediction", "algorithm", "cost"], minDescLength: 400 },
    "MECH_06": { title: "Automated Dimension Inspection Station", requiredComponents: ["laser sensor", "camera", "conveyor", "plc", "servo"], requiredKeywords: ["dimension", "inspection", "measurement", "tolerance", "laser", "automated", "spc"], requiredSections: ["component", "working", "measurement", "accuracy", "spc", "cost"], minDescLength: 400 },
    "MECH_07": { title: "Conveyor Belt Health Monitoring", requiredComponents: ["encoder", "camera", "vibration sensor", "esp32", "display"], requiredKeywords: ["conveyor", "belt", "health", "tear", "splice", "tracking", "monitoring"], requiredSections: ["component", "working", "detection", "monitoring", "alert", "cost"], minDescLength: 400 },
    "MECH_08": { title: "Weld Quality Monitoring System", requiredComponents: ["current sensor", "voltage sensor", "camera", "data logger", "display"], requiredKeywords: ["weld", "quality", "current", "voltage", "monitoring", "defect", "parameter"], requiredSections: ["component", "working", "monitoring", "detection", "traceability", "cost"], minDescLength: 400 },
    "MECH_09": { title: "HVAC Energy Optimization System", requiredComponents: ["temperature sensor", "occupancy sensor", "vfd", "bms", "display"], requiredKeywords: ["hvac", "energy", "optimization", "temperature", "occupancy", "vfd", "comfort"], requiredSections: ["component", "working", "control", "optimization", "savings", "cost"], minDescLength: 400 },
    "MECH_10": { title: "Tool Wear Monitoring in Turning", requiredComponents: ["force sensor", "accelerometer", "acoustic sensor", "esp32", "display"], requiredKeywords: ["tool", "wear", "turning", "cutting", "force", "vibration", "prediction", "life"], requiredSections: ["component", "working", "monitoring", "prediction", "tool change", "cost"], minDescLength: 400 }
};

// =====================================================
// QUESTIONS - Built from Answer Keys
// =====================================================
const QUESTIONS = {
    'CSE/IT': [],
    'ECE': [],
    'EEE': [],
    'MECH': []
};

// Build CSE questions from answer keys
for (let i = 1; i <= 80; i++) {
    const id = `CSE_${String(i).padStart(2, '0')}`;
    const ak = ANSWER_KEYS[id];
    QUESTIONS['CSE/IT'].push({
        id: id,
        title: ak.title,
        type: 'code',
        scenario: `üéØ **Your Task:** Build an MCP (Model Context Protocol) Server for "${ak.title}"

üìã **Required Tools to Implement:**
‚Ä¢ ${ak.requiredTools.join('\n‚Ä¢ ')}

üí° **Key Requirements:**
1. Use MCPServer from @modelcontextprotocol/sdk
2. Implement all required tools using server.tool()
3. Include proper async/await handling
4. Add try-catch error handling for each tool
5. Return meaningful responses

üìù **Expected Functions:** ${ak.expectedFunctions.join(', ')}

‚ö†Ô∏è **Important:** Your code should be production-ready with proper error handling and clear documentation.`,
        keywords: ak.requiredKeywords,
        answerKey: ak
    });
}

// Build ECE questions from answer keys
for (let i = 1; i <= 25; i++) {
    const id = `ECE_${String(i).padStart(2, '0')}`;
    const ak = ANSWER_KEYS[id];
    QUESTIONS['ECE'].push({
        id: id,
        title: ak.title,
        type: 'simulation',
        scenario: `üéØ **Your Task:** Design and simulate "${ak.title}" in Tinkercad

üìã **Required Components:**
‚Ä¢ ${ak.requiredComponents.join('\n‚Ä¢ ')}

üí° **Documentation Must Include:**
1. **Component List** - All parts used with specifications
2. **Working Principle** - How the system operates
3. **Circuit Connections** - Pin-by-pin connections
4. **Algorithm/Logic** - Step-by-step operation
5. **Power Requirements** - Voltage, current needs
6. **Cost Estimation** - Approximate budget

üìù **Key Features to Implement:** ${ak.requiredKeywords.slice(0, 5).join(', ')}

‚ö†Ô∏è **Important:** Create a working simulation in Tinkercad and provide the shareable link.`,
        keywords: ak.requiredKeywords,
        answerKey: ak
    });
}

// Build EEE questions from answer keys
for (let i = 1; i <= 10; i++) {
    const id = `EEE_${String(i).padStart(2, '0')}`;
    const ak = ANSWER_KEYS[id];
    QUESTIONS['EEE'].push({
        id: id,
        title: ak.title,
        type: 'simulation',
        scenario: `üéØ **Your Task:** Design and simulate "${ak.title}" for Power System Monitoring

üìã **Required Components:**
‚Ä¢ ${ak.requiredComponents.join('\n‚Ä¢ ')}

üí° **Documentation Must Include:**
1. **Component List** - All parts with ratings
2. **Working Principle** - System operation
3. **Circuit Design** - Schematic connections
4. **Algorithm** - Control/monitoring logic
5. **Safety Features** - Protection mechanisms
6. **Cost Analysis** - Implementation budget

üìù **Key Features:** ${ak.requiredKeywords.slice(0, 5).join(', ')}

‚ö†Ô∏è **Important:** Create a working Tinkercad simulation and provide the shareable link.`,
        keywords: ak.requiredKeywords,
        answerKey: ak
    });
}

// Build MECH questions from answer keys
for (let i = 1; i <= 10; i++) {
    const id = `MECH_${String(i).padStart(2, '0')}`;
    const ak = ANSWER_KEYS[id];
    QUESTIONS['MECH'].push({
        id: id,
        title: ak.title,
        type: 'simulation',
        scenario: `üéØ **Your Task:** Design "${ak.title}" for Smart Manufacturing/AI-Powered System

üìã **Required Components:**
‚Ä¢ ${ak.requiredComponents.join('\n‚Ä¢ ')}

üí° **Documentation Must Include:**
1. **Component List** - All parts with specifications
2. **Working Principle** - System operation flow
3. **Circuit/Mechanism** - Design connections
4. **Algorithm** - AI/Control logic
5. **Deployment Strategy** - Installation plan
6. **ROI Analysis** - Cost-benefit calculation

üìù **Key Features:** ${ak.requiredKeywords.slice(0, 5).join(', ')}

‚ö†Ô∏è **Important:** Create a working Tinkercad simulation and provide the shareable link.`,
        keywords: ak.requiredKeywords,
        answerKey: ak
    });
}

// =====================================================
// STATE
// =====================================================
let currentUser = null;
let currentQuestion = null;
let timerInterval = null;
let startTime = null;
let answers = {};
let screenshot = null;
let screenshotData = { width: 0, height: 0, size: 0 }; // Track screenshot metadata
let dashboardData = [];

// =====================================================
// SCREENSHOT VALIDATION
// =====================================================
function validateScreenshot() {
    if (!screenshot || !screenshotData.width) {
        return { score: 0, reason: 'No screenshot uploaded' };
    }
    
    const { width, height, size } = screenshotData;
    
    // Check 1: Minimum dimensions (at least 400x300)
    if (width < 400 || height < 300) {
        return { score: 3, reason: `Too small (${width}x${height}). Need min 400x300` };
    }
    
    // Check 2: Minimum file size (at least 30KB - not a blank/icon image)
    if (size < 30000) {
        return { score: 5, reason: `File too small (${Math.round(size/1024)}KB). Upload actual screenshot.` };
    }
    
    // Check 3: Aspect ratio (should be reasonable screen ratio)
    const ratio = width / height;
    if (ratio < 0.5 || ratio > 3) {
        return { score: 5, reason: 'Invalid aspect ratio. Upload proper screenshot.' };
    }
    
    // Check 4: Excellent - Large HD screenshot
    if (width >= 1000 && height >= 700 && size >= 150000) {
        return { score: 15, reason: 'Excellent screenshot ‚úì' };
    }
    
    // Check 5: Good - Medium quality
    if (width >= 800 && height >= 600 && size >= 80000) {
        return { score: 13, reason: 'Good screenshot ‚úì' };
    }
    
    // Check 6: Acceptable
    if (width >= 600 && height >= 400 && size >= 50000) {
        return { score: 10, reason: 'Acceptable screenshot' };
    }
    
    // Basic valid but low quality
    return { score: 7, reason: 'Low quality screenshot' };
}

// =====================================================
// EVALUATION
// =====================================================
function evaluate() {
    const q = currentQuestion;
    const breakdown = [];
    let score = 0;
    const ak = q.answerKey || ANSWER_KEYS[q.id] || {};
    
    if (q.type === 'code') {
        // CSE/IT - Full Auto Evaluation (85 points code + 15 screenshot)
        const code = (answers.code || '').toLowerCase();
        
        // 1. MCP Structure Check (25 points)
        let mcpScore = 0;
        if (code.includes('mcpserver')) mcpScore += 10;
        if (code.includes('server.tool') || code.includes('server.resource')) mcpScore += 8;
        if (code.includes('async')) mcpScore += 4;
        if (code.includes('await')) mcpScore += 3;
        mcpScore = Math.min(25, mcpScore);
        breakdown.push({ name: 'MCP Structure', score: mcpScore, max: 25 });
        score += mcpScore;
        
        // 2. Required Tools Check (20 points) - FROM ANSWER KEY
        let toolScore = 0;
        if (ak.requiredTools) {
            ak.requiredTools.forEach(tool => {
                if (code.includes(tool.toLowerCase())) toolScore += 4;
            });
            toolScore = Math.min(20, toolScore);
        }
        breakdown.push({ name: 'Required Tools', score: toolScore, max: 20 });
        score += toolScore;
        
        // 3. Domain Keywords Check (15 points) - FROM ANSWER KEY
        let kwScore = 0;
        if (ak.requiredKeywords) {
            ak.requiredKeywords.forEach(kw => {
                if (code.includes(kw.toLowerCase())) kwScore += 2;
            });
            kwScore = Math.min(15, kwScore);
        }
        breakdown.push({ name: 'Domain Keywords', score: kwScore, max: 15 });
        score += kwScore;
        
        // 4. Code Patterns Check (15 points)
        let patScore = 0;
        const patterns = ak.requiredPatterns || ['try', 'catch', 'if', 'return', 'async', 'await'];
        patterns.forEach(p => { if (code.includes(p.toLowerCase())) patScore += 3; });
        patScore = Math.min(15, patScore);
        breakdown.push({ name: 'Code Patterns', score: patScore, max: 15 });
        score += patScore;
        
        // 5. Expected Functions Check (10 points)
        let funcScore = 0;
        if (ak.expectedFunctions) {
            ak.expectedFunctions.forEach(fn => {
                if (code.includes(fn.toLowerCase())) funcScore += 3;
            });
            funcScore = Math.min(10, funcScore);
        }
        breakdown.push({ name: 'Expected Functions', score: funcScore, max: 10 });
        score += funcScore;
        
        // Screenshot (15 points)
        const ssResult = validateScreenshot();
        breakdown.push({ name: 'Screenshot', score: ssResult.score, max: 15, reason: ssResult.reason });
        score += ssResult.score;
        
    } else {
        // ECE/EEE/MECH - HYBRID Evaluation
        // Auto: 60 points | Manual: 40 points (by facilitator)
        const link = answers.link || '';
        const desc = (answers.desc || '').toLowerCase();
        
        // ========== AUTO EVALUATION (60 points) ==========
        
        // 1. Tinkercad Link Format (10 points)
        let linkScore = 0;
        if (link.includes('tinkercad.com/things/')) {
            linkScore = 10; // Valid Tinkercad project link
        } else if (link.includes('tinkercad.com')) {
            linkScore = 5; // Tinkercad but not proper project link
        } else if (link.length > 10) {
            linkScore = 2; // Some link provided
        }
        breakdown.push({ name: 'Tinkercad Link', score: linkScore, max: 10, type: 'auto' });
        score += linkScore;
        
        // 2. Description Quality - Keywords (25 points) - FROM ANSWER KEY
        let kwScore = 0;
        if (ak.requiredKeywords) {
            ak.requiredKeywords.forEach(kw => {
                if (desc.includes(kw.toLowerCase())) kwScore += 4;
            });
            kwScore = Math.min(25, kwScore);
        }
        breakdown.push({ name: 'Technical Keywords', score: kwScore, max: 25, type: 'auto' });
        score += kwScore;
        
        // 3. Required Sections Present (15 points) - FROM ANSWER KEY
        let sectScore = 0;
        if (ak.requiredSections) {
            ak.requiredSections.forEach(sect => {
                if (desc.includes(sect.toLowerCase())) sectScore += 3;
            });
            sectScore = Math.min(15, sectScore);
        }
        breakdown.push({ name: 'Documentation Sections', score: sectScore, max: 15, type: 'auto' });
        score += sectScore;
        
        // 4. Screenshot Uploaded (10 points)
        const ssResult = validateScreenshot();
        breakdown.push({ name: 'Screenshot Quality', score: Math.min(10, ssResult.score), max: 10, type: 'auto', reason: ssResult.reason });
        score += Math.min(10, ssResult.score);
        
        // ========== MANUAL EVALUATION (40 points) - PENDING ==========
        breakdown.push({ 
            name: '‚è≥ Circuit Correctness', 
            score: 0, 
            max: 15, 
            type: 'manual',
            status: 'pending',
            note: 'Facilitator will verify'
        });
        breakdown.push({ 
            name: '‚è≥ Simulation Works', 
            score: 0, 
            max: 15, 
            type: 'manual',
            status: 'pending',
            note: 'Facilitator will verify'
        });
        breakdown.push({ 
            name: '‚è≥ Components Connected', 
            score: 0, 
            max: 10, 
            type: 'manual',
            status: 'pending',
            note: 'Facilitator will verify'
        });
    }
    
    return { 
        total: Math.min(100, score), 
        breakdown,
        autoScore: score,
        manualScore: 0,
        manualPending: q.type !== 'code',
        maxAutoScore: q.type === 'code' ? 100 : 60,
        maxManualScore: q.type === 'code' ? 0 : 40
    };
}

// =====================================================
// DATABASE OPERATIONS (REST API)
// =====================================================
async function saveToDatabase(data, isSubmit = false) {
    try {
        // Store extra evaluation data in answers JSON (existing column)
        const answersWithMeta = {
            ...data.answers,
            _evaluation: {
                autoScore: data.autoScore || 0,
                manualPending: data.manualPending || false,
                breakdown: data.breakdown || null
            }
        };
        
        const record = {
            roll_no: data.rollNo,
            name: data.name,
            email: data.email,
            phone: data.phone,
            department: data.department,
            year: data.year,
            question_id: data.questionId,
            question_type: data.type,
            status: isSubmit ? 'submitted' : 'saved',
            answers: answersWithMeta,
            code_score: data.codeScore || 0,
            screenshot_score: data.screenshotScore || 0,
            total_score: data.totalScore,
            time_taken: data.time
        };
        
        // Check if exists
        const existing = await supabaseRequest(`submissions?roll_no=eq.${encodeURIComponent(data.rollNo)}&select=id`);
        
        if (existing && existing.length > 0) {
            // Update
            await supabaseRequest(`submissions?roll_no=eq.${encodeURIComponent(data.rollNo)}`, 'PATCH', record);
        } else {
            // Insert
            await supabaseRequest('submissions', 'POST', record);
        }
        
        console.log('‚úÖ Saved to database');
        return true;
    } catch (err) {
        console.error('Database save error:', err.message);
        return false;
    }
}

async function checkExistingSubmission(rollNo) {
    try {
        // Check for ANY existing submission (saved or submitted)
        const data = await supabaseRequest(`submissions?roll_no=eq.${encodeURIComponent(rollNo)}&select=*`);
        return data && data.length > 0 ? data[0] : null;
    } catch (err) {
        console.error('Check submission error:', err.message);
        return null;
    }
}

async function loadSavedProgress(rollNo) {
    try {
        const data = await supabaseRequest(`submissions?roll_no=eq.${encodeURIComponent(rollNo)}&select=*`);
        return data && data.length > 0 ? data[0] : null;
    } catch (err) {
        console.error('Load progress error:', err.message);
        return null;
    }
}

async function loadAllSubmissions(dept = null, status = null) {
    try {
        let query = 'submissions?select=*&order=created_at.desc';
        if (dept) query += `&department=eq.${encodeURIComponent(dept)}`;
        if (status) query += `&status=eq.${status}`;
        
        const data = await supabaseRequest(query);
        return data || [];
    } catch (err) {
        console.error('Load submissions error:', err.message);
        return [];
    }
}

async function updateGrade(rollNo, updates) {
    try {
        await supabaseRequest(
            `submissions?roll_no=eq.${encodeURIComponent(rollNo)}`,
            'PATCH',
            updates
        );
        return true;
    } catch (err) {
        console.error('Update grade error:', err.message);
        return false;
    }
}

// =====================================================
// LOGIN
// =====================================================
function switchTab(tab) {
    document.querySelectorAll('.tab').forEach((t, i) => {
        t.classList.remove('active');
        if ((tab === 'learner' && i === 0) || (tab === 'facilitator' && i === 1) || (tab === 'admin' && i === 2)) {
            t.classList.add('active');
        }
    });
    document.getElementById('learnerForm').classList.add('hidden');
    document.getElementById('facilitatorForm').classList.add('hidden');
    document.getElementById('adminForm').classList.add('hidden');
    document.getElementById(tab + 'Form').classList.remove('hidden');
}

async function startAssessment() {
    const name = document.getElementById('learnerName').value.trim();
    const rollNo = document.getElementById('rollNo').value.trim().toUpperCase();
    const dept = document.getElementById('department').value;
    const year = document.getElementById('year').value;
    const email = document.getElementById('email').value.trim();
    const phone = document.getElementById('phone').value.trim();
    
    if (!name || !rollNo || !dept || !year || !email || !phone) {
        alert('Please fill all fields');
        return;
    }
    
    // Show loading
    const loginBtn = document.querySelector('#learnerForm .btn-primary');
    loginBtn.innerHTML = '‚è≥ Assigning question...';
    loginBtn.disabled = true;
    
    try {
        // Check if already submitted
        const existing = await checkExistingSubmission(rollNo);
        if (existing) {
            if (existing.status === 'submitted') {
                alert(`Already submitted!\n\nScore: ${existing.total_score}/100\nTime: ${existing.time_taken}`);
                resetLoginButton();
                return;
            } else {
                // Resume with same question (status is 'saved' or 'in_progress')
                currentQuestion = QUESTIONS[dept].find(q => q.id === existing.question_id);
                if (!currentQuestion) {
                    currentQuestion = QUESTIONS[dept][0];
                }
                currentUser = { name, rollNo, dept, year, email, phone };
                answers = existing.answers || {};
                // Remove evaluation metadata from answers for editing
                delete answers._evaluation;
                if (existing.status === 'saved') {
                    alert('üìù Resuming your saved progress!');
                }
                showAssessment();
                return;
            }
        }
        
        // Assign UNIQUE question - check which questions are already taken
        const qs = QUESTIONS[dept];
        const assignedQuestion = await assignUniqueQuestion(dept, rollNo, qs);
        
        if (!assignedQuestion) {
            alert('‚ùå All questions for your department are currently assigned. Please contact your facilitator.');
            resetLoginButton();
            return;
        }
        
        currentQuestion = assignedQuestion;
        currentUser = { name, rollNo, dept, year, email, phone };
        
        // üîí IMMEDIATELY RESERVE the question in database
        const reserved = await reserveQuestion({
            rollNo, name, email, phone, dept, year,
            questionId: currentQuestion.id,
            type: currentQuestion.type
        });
        
        if (!reserved) {
            // Someone else got this question, try again
            console.warn('‚ö†Ô∏è Question was taken, retrying...');
            const retryQuestion = await assignUniqueQuestion(dept, rollNo, qs);
            if (retryQuestion) {
                currentQuestion = retryQuestion;
                await reserveQuestion({
                    rollNo, name, email, phone, dept, year,
                    questionId: currentQuestion.id,
                    type: currentQuestion.type
                });
            }
        }
        
        showAssessment();
        
    } catch (err) {
        console.error('Login error:', err);
        alert('Error during login. Please try again.');
        resetLoginButton();
    }
}

function resetLoginButton() {
    const btn = document.querySelector('#learnerForm .btn-primary');
    if (btn) {
        btn.innerHTML = 'üöÄ Start Assessment';
        btn.disabled = false;
    }
}

// Get unique question not taken by other students
async function assignUniqueQuestion(dept, rollNo, questions) {
    try {
        // Get all taken question IDs for this department
        const taken = await supabaseRequest(
            `submissions?department=eq.${encodeURIComponent(dept)}&select=question_id,roll_no`
        );
        
        const takenQuestionIds = new Set();
        if (taken && taken.length > 0) {
            taken.forEach(s => {
                // Don't count the current student's saved progress
                if (s.roll_no !== rollNo && s.question_id) {
                    takenQuestionIds.add(s.question_id);
                }
            });
        }
        
        console.log(`üìä ${dept}: ${takenQuestionIds.size} questions taken, ${questions.length} total`);
        
        // Find available questions
        const available = questions.filter(q => !takenQuestionIds.has(q.id));
        
        if (available.length === 0) {
            console.warn('‚ö†Ô∏è All questions taken! Allowing duplicates...');
            // Fallback: assign based on roll number hash if all taken
            const idx = Math.abs(rollNo.split('').reduce((s, c) => s + c.charCodeAt(0), 0)) % questions.length;
            return questions[idx];
        }
        
        // Assign from available questions using roll number hash for consistency
        const idx = Math.abs(rollNo.split('').reduce((s, c) => s + c.charCodeAt(0), 0)) % available.length;
        
        console.log(`‚úÖ Assigned question: ${available[idx].id}`);
        return available[idx];
        
    } catch (err) {
        console.error('Question assignment error:', err);
        // Fallback to hash-based assignment
        const idx = Math.abs(rollNo.split('').reduce((s, c) => s + c.charCodeAt(0), 0)) % questions.length;
        return questions[idx];
    }
}

// üîí IMMEDIATELY reserve question in database (prevents race condition)
async function reserveQuestion(data) {
    try {
        const record = {
            roll_no: data.rollNo,
            name: data.name,
            email: data.email,
            phone: data.phone,
            department: data.dept,
            year: data.year,
            question_id: data.questionId,
            question_type: data.type,
            status: 'in_progress',
            answers: {},
            code_score: 0,
            screenshot_score: 0,
            total_score: 0,
            time_taken: '00:00:00'
        };
        
        // Try to insert - will fail if roll_no already exists (unique constraint)
        await supabaseRequest('submissions', 'POST', record);
        console.log(`üîí Reserved question ${data.questionId} for ${data.rollNo}`);
        return true;
        
    } catch (err) {
        console.error('Reserve question error:', err);
        return false;
    }
}

function loginFacilitator() {
    const codes = { 'CSE/IT': 'CSE2025', 'ECE': 'ECE2025', 'EEE': 'EEE2025', 'MECH': 'MECH2025' };
    const name = document.getElementById('facName').value.trim();
    const dept = document.getElementById('facDept').value;
    const code = document.getElementById('facCode').value;
    
    if (!name || !dept || codes[dept] !== code) {
        alert('Invalid credentials');
        return;
    }
    
    currentUser = { type: 'facilitator', name, dept };
    showDashboard();
}

function loginAdmin() {
    if (document.getElementById('adminEmail').value === 'admin@jkkn.edu' && document.getElementById('adminPass').value === 'JKKN@2025') {
        currentUser = { type: 'admin', name: 'Administrator' };
        showDashboard();
    } else {
        alert('Invalid credentials');
    }
}

function logout() {
    currentUser = null;
    currentQuestion = null;
    answers = {};
    screenshot = null;
    if (timerInterval) clearInterval(timerInterval);
    
    document.getElementById('loginPage').classList.remove('hidden');
    document.getElementById('assessmentPage').classList.add('hidden');
    document.getElementById('dashboardPage').classList.add('hidden');
    document.getElementById('userBadge').textContent = '';
    document.getElementById('logoutBtn').style.display = 'none';
}

// =====================================================
// ASSESSMENT
// =====================================================
function showAssessment() {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('assessmentPage').classList.remove('hidden');
    document.getElementById('userBadge').textContent = currentUser.name;
    document.getElementById('logoutBtn').style.display = 'block';
    
    document.getElementById('qBadge').textContent = currentQuestion.id;
    document.getElementById('qTitle').textContent = currentQuestion.title;
    
    // Format scenario with proper HTML structure
    const scenarioText = currentQuestion.scenario || '';
    
    // Convert markdown-like syntax to HTML
    let formatted = scenarioText
        // Convert **bold** to <strong>
        .replace(/\*\*(.*?)\*\*/g, '<strong style="color:#003D5B">$1</strong>')
        // Convert bullet points (‚Ä¢ or lines starting with numbers)
        .replace(/^(\d+)\.\s+/gm, '<strong>$1.</strong> ')
        // Convert `code` to styled code
        .replace(/`(.*?)`/g, '<code style="background:#e8e8e8;padding:2px 6px;border-radius:4px;font-family:monospace">$1</code>')
        // Convert line breaks
        .replace(/\n\n/g, '</p><p style="margin:0.8rem 0">')
        .replace(/\n/g, '<br>');
    
    document.getElementById('qScenario').innerHTML = `
        <div class="scenario-content" style="font-size:1.05rem;line-height:2;color:#333">
            <p style="margin:0">${formatted}</p>
        </div>
    `;
    
    // Scroll to top of assessment page
    document.getElementById('assessmentPage').scrollTop = 0;
    window.scrollTo(0, 0);
    
    renderTasks();
    startTimer();
}

function renderTasks() {
    const area = document.getElementById('tasksArea');
    
    if (currentQuestion.type === 'code') {
        area.innerHTML = `
            <div class="task-section">
                <div class="task-header">
                    <span class="task-title">üìù MCP Server Code</span>
                    <span class="task-marks">85 marks</span>
                </div>
                <textarea class="code-editor" id="codeInput" placeholder="// Write your MCP server code here
import { MCPServer } from '@modelcontextprotocol/sdk';

const server = new MCPServer({
    name: 'my-server'
});

server.tool('myTool', async (params) => {
    try {
        return { success: true };
    } catch (error) {
        return { error: error.message };
    }
});" oninput="updateChecklist()">${answers.code || ''}</textarea>
            </div>
            
            <div class="screenshot-section">
                <h3>üì∏ Screenshot (15 marks)</h3>
                <p style="color:#666;font-size:0.85rem;margin-bottom:0.5rem">
                    üìã Requirements: Min 400x300 pixels, Min 30KB file size
                </p>
                <div class="upload-area ${screenshot ? 'has-file' : ''}" onclick="document.getElementById('ssFile').click()">
                    <div class="upload-icon">${screenshot ? '‚úÖ' : 'üì∑'}</div>
                    <div>${screenshot ? 'Uploaded!' : 'Click to upload'}</div>
                </div>
                <input type="file" id="ssFile" accept="image/*" style="display:none" onchange="handleFile(event)">
                <div class="preview-box ${screenshot ? 'active' : ''}" id="previewBox">
                    <img class="preview-img" id="previewImg" src="${screenshot || ''}">
                    ${screenshot ? `
                        <div style="margin-top:0.5rem;padding:0.5rem;background:#f5f7fa;border-radius:6px;font-size:0.85rem">
                            <strong>Size:</strong> ${screenshotData.width}x${screenshotData.height} | 
                            <strong>File:</strong> ${Math.round(screenshotData.size/1024)}KB |
                            <strong>Score:</strong> <span style="color:${validateScreenshot().score >= 12 ? '#28a745' : validateScreenshot().score >= 8 ? '#ffc107' : '#dc3545'}">${validateScreenshot().score}/15</span>
                            <div style="color:#666;margin-top:0.25rem">${validateScreenshot().reason}</div>
                        </div>
                    ` : ''}
                    <button class="btn btn-secondary" style="margin-top:0.5rem" onclick="removeFile();event.stopPropagation()">Remove</button>
                </div>
            </div>
        `;
    } else {
        area.innerHTML = `
            <div class="task-section">
                <div class="task-header">
                    <span class="task-title">üîó Tinkercad Link</span>
                    <span class="task-marks">25 marks</span>
                </div>
                <input type="url" id="linkInput" style="width:100%;padding:0.7rem;border:2px solid #e0e0e0;border-radius:6px"
                    placeholder="https://www.tinkercad.com/things/..." 
                    value="${answers.link || ''}" oninput="updateChecklist()">
            </div>
            
            <div class="task-section">
                <div class="task-header">
                    <span class="task-title">üìÑ Documentation</span>
                    <span class="task-marks">60 marks</span>
                </div>
                <textarea class="text-area" id="descInput" placeholder="Describe your design..." oninput="updateChecklist()">${answers.desc || ''}</textarea>
            </div>
            
            <div class="screenshot-section">
                <h3>üì∏ Screenshot (15 marks)</h3>
                <p style="color:#666;font-size:0.85rem;margin-bottom:0.5rem">
                    üìã Requirements: Min 400x300 pixels, Min 30KB file size
                </p>
                <div class="upload-area ${screenshot ? 'has-file' : ''}" onclick="document.getElementById('ssFile').click()">
                    <div class="upload-icon">${screenshot ? '‚úÖ' : 'üì∑'}</div>
                    <div>${screenshot ? 'Uploaded!' : 'Click to upload'}</div>
                </div>
                <input type="file" id="ssFile" accept="image/*" style="display:none" onchange="handleFile(event)">
                <div class="preview-box ${screenshot ? 'active' : ''}" id="previewBox">
                    <img class="preview-img" id="previewImg" src="${screenshot || ''}">
                    ${screenshot ? `
                        <div style="margin-top:0.5rem;padding:0.5rem;background:#f5f7fa;border-radius:6px;font-size:0.85rem">
                            <strong>Size:</strong> ${screenshotData.width}x${screenshotData.height} | 
                            <strong>File:</strong> ${Math.round(screenshotData.size/1024)}KB |
                            <strong>Score:</strong> <span style="color:${validateScreenshot().score >= 12 ? '#28a745' : validateScreenshot().score >= 8 ? '#ffc107' : '#dc3545'}">${validateScreenshot().score}/15</span>
                            <div style="color:#666;margin-top:0.25rem">${validateScreenshot().reason}</div>
                        </div>
                    ` : ''}
                    <button class="btn btn-secondary" style="margin-top:0.5rem" onclick="removeFile();event.stopPropagation()">Remove</button>
                </div>
            </div>
        `;
    }
    
    updateChecklist();
}

function handleFile(e) {
    const file = e.target.files[0];
    if (!file) return;
    if (file.size > 5 * 1024 * 1024) { alert('Max 5MB'); return; }
    
    // Store file size
    screenshotData.size = file.size;
    
    const reader = new FileReader();
    reader.onload = (ev) => {
        screenshot = ev.target.result;
        
        // Get image dimensions
        const img = new Image();
        img.onload = () => {
            screenshotData.width = img.width;
            screenshotData.height = img.height;
            
            // Show validation feedback
            const validation = validateScreenshot();
            console.log('Screenshot validation:', validation);
            
            renderTasks();
        };
        img.src = screenshot;
    };
    reader.readAsDataURL(file);
}

function removeFile() {
    screenshot = null;
    screenshotData = { width: 0, height: 0, size: 0 };
    renderTasks();
}

function updateChecklist() {
    const items = document.getElementById('checklistItems');
    
    if (currentQuestion.type === 'code') {
        const code = document.getElementById('codeInput')?.value || '';
        items.innerHTML = `
            <div class="check-item ${code.length >= 50 ? 'done' : ''}">
                ${code.length >= 50 ? '‚úÖ' : '‚¨ú'} Code (${code.length}/50 min)
            </div>
            <div class="check-item ${screenshot ? 'done' : ''}">
                ${screenshot ? '‚úÖ' : '‚¨ú'} Screenshot
            </div>
        `;
    } else {
        const link = document.getElementById('linkInput')?.value || '';
        const desc = document.getElementById('descInput')?.value || '';
        items.innerHTML = `
            <div class="check-item ${link.length > 10 ? 'done' : ''}">
                ${link.length > 10 ? '‚úÖ' : '‚¨ú'} Link
            </div>
            <div class="check-item ${desc.length >= 50 ? 'done' : ''}">
                ${desc.length >= 50 ? '‚úÖ' : '‚¨ú'} Docs (${desc.length}/50 min)
            </div>
            <div class="check-item ${screenshot ? 'done' : ''}">
                ${screenshot ? '‚úÖ' : '‚¨ú'} Screenshot
            </div>
        `;
    }
}

function startTimer() {
    startTime = Date.now();
    timerInterval = setInterval(() => {
        const s = Math.floor((Date.now() - startTime) / 1000);
        const h = String(Math.floor(s / 3600)).padStart(2, '0');
        const m = String(Math.floor((s % 3600) / 60)).padStart(2, '0');
        const sec = String(s % 60).padStart(2, '0');
        document.getElementById('timer').textContent = `${h}:${m}:${sec}`;
    }, 1000);
}

function collectAnswers() {
    if (currentQuestion.type === 'code') {
        answers.code = document.getElementById('codeInput')?.value || '';
    } else {
        answers.link = document.getElementById('linkInput')?.value || '';
        answers.desc = document.getElementById('descInput')?.value || '';
    }
}

// =====================================================
// SAVE
// =====================================================
async function saveWork() {
    collectAnswers();
    
    const result = evaluate();
    
    const data = {
        rollNo: currentUser.rollNo,
        name: currentUser.name,
        email: currentUser.email,
        phone: currentUser.phone,
        department: currentUser.dept,
        year: currentUser.year,
        questionId: currentQuestion.id,
        type: currentQuestion.type,
        answers: { ...answers },
        codeScore: result.total - (screenshot ? 15 : 0),
        screenshotScore: screenshot ? 15 : 0,
        totalScore: result.total,
        time: document.getElementById('timer').textContent
    };
    
    document.getElementById('saveStatus').innerHTML = '‚è≥ Saving to cloud...';
    
    const success = await saveToDatabase(data, false);
    
    if (success) {
        document.getElementById('saveStatus').innerHTML = `<span class="saved">‚úÖ Saved to cloud! Score: ${result.total}/100</span>`;
    } else {
        document.getElementById('saveStatus').innerHTML = '‚ùå Save failed - try again';
    }
}

// =====================================================
// FINAL SUBMIT
// =====================================================
async function finalSubmit() {
    collectAnswers();
    
    // Validate
    if (currentQuestion.type === 'code') {
        if ((answers.code || '').length < 50) {
            alert('Please write at least 50 characters of code');
            return;
        }
    } else {
        if (!(answers.link || '').length || (answers.desc || '').length < 50) {
            alert('Please provide Tinkercad link and documentation (50+ chars)');
            return;
        }
    }
    
    // Confirm with appropriate message
    const confirmMsg = currentQuestion.type === 'code' 
        ? 'üö® FINAL SUBMISSION\n\nThis CANNOT be undone!\n\nClick OK to submit.'
        : 'üö® FINAL SUBMISSION\n\nThis CANNOT be undone!\n\nNote: Your facilitator will review your Tinkercad simulation and add manual scores (up to 40 points).\n\nClick OK to submit.';
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    // Evaluate
    const result = evaluate();
    
    const data = {
        rollNo: currentUser.rollNo,
        name: currentUser.name,
        email: currentUser.email,
        phone: currentUser.phone,
        department: currentUser.dept,
        year: currentUser.year,
        questionId: currentQuestion.id,
        type: currentQuestion.type,
        answers: { ...answers },
        codeScore: currentQuestion.type === 'code' ? (result.total - (screenshot ? 15 : 0)) : 0,
        screenshotScore: screenshot ? (currentQuestion.type === 'code' ? 15 : 10) : 0,
        autoScore: result.autoScore || result.total,
        manualScore: result.manualScore || 0,
        manualPending: result.manualPending || false,
        totalScore: result.total,
        breakdown: JSON.stringify(result.breakdown),
        time: document.getElementById('timer').textContent
    };
    
    // Save to database
    const success = await saveToDatabase(data, true);
    
    if (success) {
        showResult(result);
    } else {
        alert('‚ùå Submission failed. Please try again.');
    }
}

function showResult(result) {
    const isHybrid = result.manualPending;
    const displayScore = isHybrid ? result.autoScore : result.total;
    const maxScore = isHybrid ? result.maxAutoScore : 100;
    
    // Adjust icon/title for hybrid
    let icon, title;
    if (isHybrid) {
        icon = displayScore >= 45 ? '‚úÖ' : displayScore >= 25 ? 'üìã' : 'üìù';
        title = displayScore >= 45 ? 'Auto-Check Passed!' : displayScore >= 25 ? 'Submitted for Review' : 'Submitted';
    } else {
        icon = result.total >= 70 ? 'üéâ' : result.total >= 40 ? 'üëç' : 'üìù';
        title = result.total >= 70 ? 'Excellent!' : result.total >= 40 ? 'Good Job!' : 'Submitted!';
    }
    
    document.getElementById('resIcon').textContent = icon;
    document.getElementById('resTitle').textContent = title;
    
    // Show different score display for hybrid
    if (isHybrid) {
        document.getElementById('resScore').innerHTML = `
            <div>${displayScore}/${maxScore}</div>
            <div style="font-size:14px;color:#f59e0b;margin-top:3px">‚è≥ +40 pts pending review</div>
        `;
    } else {
        document.getElementById('resScore').textContent = result.total + '/100';
    }
    
    // Build COMPACT breakdown HTML
    let html = '';
    
    if (isHybrid) {
        // Simplified breakdown for ECE/EEE/MECH
        const autoItems = result.breakdown.filter(b => b.type !== 'manual');
        const manualItems = result.breakdown.filter(b => b.type === 'manual');
        
        html += `<div style="font-size:13px">
            <div style="background:#d1fae5;padding:6px 10px;border-radius:6px;margin-bottom:8px"><strong>‚úÖ Auto Score: ${result.autoScore}/${result.maxAutoScore}</strong></div>`;
        
        autoItems.forEach(b => {
            html += `<div class="bd-row"><span>${b.name}</span><span>${b.score}/${b.max}</span></div>`;
        });
        
        html += `<div style="background:#fef3c7;padding:6px 10px;border-radius:6px;margin:8px 0"><strong>‚è≥ Manual: 0/${result.maxManualScore} (pending)</strong></div>
            <div style="font-size:12px;color:#666">Facilitator will review: Circuit, Simulation, Components</div>
        </div>`;
    } else {
        // Full breakdown for CSE/IT
        html += '<h4 style="margin:0 0 8px">Score Breakdown</h4>';
        result.breakdown.forEach(b => {
            html += `<div class="bd-row">
                <span>${b.name}</span>
                <span>${b.score}/${b.max}</span>
            </div>`;
        });
        html += `<div class="bd-row total"><span>TOTAL</span><span>${result.total}/100</span></div>`;
    }
    
    document.getElementById('resBreakdown').innerHTML = html;
    
    const modal = document.getElementById('resultOverlay');
    modal.style.display = 'flex';
    modal.classList.add('show');
}

function closeResultAndLogout() {
    document.getElementById('resultOverlay').style.display = 'none';
    document.getElementById('resultOverlay').classList.remove('show');
    logout();
}

// =====================================================
// DASHBOARD
// =====================================================
async function showDashboard() {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('dashboardPage').classList.remove('hidden');
    document.getElementById('userBadge').textContent = currentUser.name + (currentUser.type === 'facilitator' ? ` (${currentUser.dept})` : ' (Admin)');
    document.getElementById('logoutBtn').style.display = 'block';
    
    if (currentUser.type === 'facilitator') {
        document.getElementById('filterDept').value = currentUser.dept;
        document.getElementById('filterDept').disabled = true;
    }
    
    await loadDashboard();
}

async function loadDashboard() {
    document.getElementById('tableContainer').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading from cloud...</p></div>';
    
    const dept = document.getElementById('filterDept').value || (currentUser.type === 'facilitator' ? currentUser.dept : null);
    const status = document.getElementById('filterStatus').value || null;
    
    // Load data - handle pending_review specially
    let filterStatus = status;
    if (status === 'pending_review') {
        filterStatus = 'submitted'; // Load submitted, then filter for pending
    }
    
    dashboardData = await loadAllSubmissions(dept, filterStatus);
    
    // Apply pending_review filter
    if (status === 'pending_review') {
        dashboardData = dashboardData.filter(s => {
            const evalData = s.answers?._evaluation || {};
            return s.question_type !== 'code' && evalData.manualPending && !s.manual_score;
        });
    }
    
    // Calculate stats
    const total = dashboardData.length;
    const submitted = dashboardData.filter(s => s.status === 'submitted');
    const pendingReview = dashboardData.filter(s => {
        const evalData = s.answers?._evaluation || {};
        return s.question_type !== 'code' && evalData.manualPending && !s.manual_score;
    });
    const avgScore = submitted.length ? Math.round(submitted.reduce((sum, s) => sum + (s.total_score || 0), 0) / submitted.length) : 0;
    const passed = dashboardData.filter(s => (s.total_score || 0) >= 40).length;
    
    document.getElementById('statTotal').textContent = total;
    document.getElementById('statAvg').textContent = avgScore + '%';
    document.getElementById('statSubmitted').textContent = submitted.length;
    document.getElementById('statPassed').textContent = pendingReview.length > 0 ? `${passed} (‚è≥${pendingReview.length})` : passed;
    
    if (dashboardData.length === 0) {
        document.getElementById('tableContainer').innerHTML = '<div class="loading"><p>No submissions yet</p></div>';
        return;
    }
    
    let html = `<table>
        <thead>
            <tr><th>Name</th><th>Roll No</th><th>Dept</th><th>Question</th><th>Score</th><th>Status</th><th>Time</th><th>Actions</th></tr>
        </thead>
        <tbody>`;
    
    dashboardData.forEach(s => {
        const sc = s.total_score || 0;
        // Read evaluation data from answers JSON
        const evalData = s.answers?._evaluation || {};
        const isHybrid = s.question_type !== 'code' && evalData.manualPending && !s.manual_score;
        const autoScore = evalData.autoScore || s.code_score || 0;
        const finalScore = s.manual_score ? (autoScore + s.manual_score) : sc;
        const cls = finalScore >= 70 ? 'score-high' : finalScore >= 40 ? 'score-medium' : 'score-low';
        const stCls = s.status === 'submitted' ? 'status-submitted' : 'status-saved';
        
        // Show pending badge for hybrid submissions
        let scoreDisplay = '';
        if (isHybrid) {
            scoreDisplay = `<span class="score-badge ${cls}">${autoScore}/60</span> <span style="background:#fef3c7;color:#92400e;padding:2px 6px;border-radius:4px;font-size:11px">‚è≥ +40 pending</span>`;
        } else if (s.question_type !== 'code' && s.manual_score) {
            scoreDisplay = `<span class="score-badge ${cls}">${finalScore}/100</span> <span style="background:#d1fae5;color:#065f46;padding:2px 6px;border-radius:4px;font-size:11px">‚úÖ Graded</span>`;
        } else {
            scoreDisplay = `<span class="score-badge ${cls}">${finalScore}/100</span>`;
        }
        
        // Different button for pending reviews
        let actionBtns = `<button class="btn btn-secondary" style="padding:0.3rem 0.6rem;font-size:0.75rem" onclick="viewSubmission('${s.roll_no}')">View</button> `;
        if (isHybrid) {
            actionBtns += `<button class="btn btn-primary" style="padding:0.3rem 0.6rem;font-size:0.75rem;background:#f59e0b" onclick="gradeSubmission('${s.roll_no}')">‚è≥ Grade Now</button>`;
        } else {
            actionBtns += `<button class="btn btn-primary" style="padding:0.3rem 0.6rem;font-size:0.75rem" onclick="gradeSubmission('${s.roll_no}')">Grade</button>`;
        }
        
        html += `<tr ${isHybrid ? 'style="background:#fef9c3"' : ''}>
            <td><strong>${s.name}</strong></td>
            <td>${s.roll_no}</td>
            <td>${s.department}</td>
            <td>${s.question_id}</td>
            <td>${scoreDisplay}</td>
            <td><span class="status-badge ${stCls}">${s.status}</span></td>
            <td>${s.time_taken || '-'}</td>
            <td>${actionBtns}</td>
        </tr>`;
    });
    
    html += '</tbody></table>';
    document.getElementById('tableContainer').innerHTML = html;
}

function viewSubmission(rollNo) {
    const s = dashboardData.find(x => x.roll_no === rollNo);
    if (!s) return;
    
    const ans = s.answers || {};
    
    let html = `
        <p><strong>Student:</strong> ${s.name} (${s.roll_no})</p>
        <p><strong>Email:</strong> ${s.email}</p>
        <p><strong>Phone:</strong> ${s.phone}</p>
        <p><strong>Department:</strong> ${s.department}</p>
        <p><strong>Question:</strong> ${s.question_id}</p>
        <p><strong>Status:</strong> <span class="status-badge ${s.status === 'submitted' ? 'status-submitted' : 'status-saved'}">${s.status}</span></p>
        <p><strong>Auto Score:</strong> <span class="score-badge ${s.total_score >= 70 ? 'score-high' : s.total_score >= 40 ? 'score-medium' : 'score-low'}">${s.total_score}/100</span></p>
        ${s.manual_score ? `<p><strong>Manual Score:</strong> ${s.manual_score}/100</p>` : ''}
        ${s.comments ? `<p><strong>Comments:</strong> ${s.comments}</p>` : ''}
        <p><strong>Time:</strong> ${s.time_taken || '-'}</p>
    `;
    
    if (s.question_type === 'code') {
        html += `<h4 style="margin-top:1rem">Code</h4><pre>${(ans.code || 'No code').replace(/</g, '&lt;')}</pre>`;
    } else {
        html += `<h4 style="margin-top:1rem">Tinkercad Link</h4><p><a href="${ans.link || '#'}" target="_blank">${ans.link || 'N/A'}</a></p>`;
        html += `<h4>Documentation</h4><pre style="background:#f5f5f5;color:#333">${(ans.desc || 'No description').replace(/</g, '&lt;')}</pre>`;
    }
    
    document.getElementById('viewContent').innerHTML = html;
    document.getElementById('viewModal').classList.add('active');
}

function gradeSubmission(rollNo) {
    const s = dashboardData.find(x => x.roll_no === rollNo);
    if (!s) return;
    
    const isHybrid = s.question_type !== 'code';
    const ans = s.answers || {};
    const evalData = ans._evaluation || {};
    const autoScore = evalData.autoScore || s.code_score || 0;
    
    let html = `
        <div style="border-bottom:1px solid #e5e7eb;padding-bottom:10px;margin-bottom:15px">
            <p><strong>${s.name}</strong> (${s.roll_no})</p>
            <p>Department: ${s.department} | Question: ${s.question_id}</p>
        </div>
    `;
    
    if (isHybrid) {
        // HYBRID GRADING - ECE/EEE/MECH
        html += `
            <div style="background:#e0f2fe;padding:10px;border-radius:8px;margin-bottom:15px">
                <strong>üìä Auto Score:</strong> ${autoScore}/60 points
            </div>
            
            <div style="background:#fef3c7;padding:10px;border-radius:8px;margin-bottom:15px">
                <strong>üîó Tinkercad Link:</strong><br>
                <a href="${ans.link || '#'}" target="_blank" style="word-break:break-all;color:#2563eb">${ans.link || 'Not provided'}</a>
                <br><button onclick="window.open('${ans.link}','_blank')" style="margin-top:8px" class="btn btn-secondary">üîç Open Tinkercad to Verify</button>
            </div>
            
            <h4 style="margin:15px 0 10px">‚ö° Manual Evaluation (40 points max)</h4>
            <p style="font-size:13px;color:#6b7280;margin-bottom:15px">Review the Tinkercad simulation and award points:</p>
            
            <div class="form-group">
                <label>üîß Circuit Correctness (0-15 pts)</label>
                <p style="font-size:12px;color:#6b7280;margin:2px 0 5px">Are all components connected correctly? Is the circuit design appropriate?</p>
                <input type="number" id="manualCircuit" min="0" max="15" value="0" style="width:100%">
            </div>
            
            <div class="form-group">
                <label>‚úÖ Simulation Works (0-15 pts)</label>
                <p style="font-size:12px;color:#6b7280;margin:2px 0 5px">Does the simulation run? Do outputs match expected behavior?</p>
                <input type="number" id="manualSimulation" min="0" max="15" value="0" style="width:100%">
            </div>
            
            <div class="form-group">
                <label>üîå Components Connected Properly (0-10 pts)</label>
                <p style="font-size:12px;color:#6b7280;margin:2px 0 5px">Are wiring connections neat? Are required components present?</p>
                <input type="number" id="manualComponents" min="0" max="10" value="0" style="width:100%">
            </div>
            
            <div style="background:#f3f4f6;padding:10px;border-radius:8px;margin:15px 0">
                <strong>Manual Total:</strong> <span id="manualTotalPreview">0</span>/40
                <br><strong>Final Score:</strong> <span id="finalScorePreview">${autoScore}</span>/100
            </div>
        `;
    } else {
        // CODE GRADING - CSE/IT (already auto-evaluated, manual override)
        html += `
            <div style="background:#d1fae5;padding:10px;border-radius:8px;margin-bottom:15px">
                <strong>üìä Auto Score:</strong> ${s.total_score || 0}/100 points (fully evaluated)
            </div>
            
            <div class="form-group">
                <label>Override Score (0-100) - Optional</label>
                <p style="font-size:12px;color:#6b7280;margin:2px 0 5px">Only change if auto-evaluation needs correction</p>
                <input type="number" id="manualScore" min="0" max="100" value="${s.manual_score || s.total_score}">
            </div>
        `;
    }
    
    html += `
        <div class="form-group">
            <label>üìù Comments/Feedback</label>
            <textarea id="gradeComments" class="text-area" style="min-height:80px" placeholder="Provide feedback to the student...">${s.comments || ''}</textarea>
        </div>
        <button class="btn btn-primary btn-lg" style="width:100%" onclick="saveGrade('${rollNo}', ${isHybrid})">üíæ Save Grade</button>
    `;
    
    document.getElementById('gradeContent').innerHTML = html;
    document.getElementById('gradeModal').classList.add('active');
    
    // Add live preview for hybrid
    if (isHybrid) {
        const updatePreview = () => {
            const c = parseInt(document.getElementById('manualCircuit').value) || 0;
            const sim = parseInt(document.getElementById('manualSimulation').value) || 0;
            const p = parseInt(document.getElementById('manualComponents').value) || 0;
            const total = c + sim + p;
            document.getElementById('manualTotalPreview').textContent = total;
            document.getElementById('finalScorePreview').textContent = autoScore + total;
        };
        document.getElementById('manualCircuit').addEventListener('input', updatePreview);
        document.getElementById('manualSimulation').addEventListener('input', updatePreview);
        document.getElementById('manualComponents').addEventListener('input', updatePreview);
    }
}

async function saveGrade(rollNo, isHybrid = false) {
    let manualScore = 0;
    let updates = {};
    
    if (isHybrid) {
        const circuit = parseInt(document.getElementById('manualCircuit').value) || 0;
        const simulation = parseInt(document.getElementById('manualSimulation').value) || 0;
        const components = parseInt(document.getElementById('manualComponents').value) || 0;
        
        if (circuit < 0 || circuit > 15 || simulation < 0 || simulation > 15 || components < 0 || components > 10) {
            alert('Enter valid scores within limits');
            return;
        }
        
        manualScore = circuit + simulation + components;
        const s = dashboardData.find(x => x.roll_no === rollNo);
        const autoScore = s.answers?._evaluation?.autoScore || s.code_score || 0;
        const finalScore = autoScore + manualScore;
        
        updates = {
            manual_score: manualScore,
            total_score: finalScore,
            comments: document.getElementById('gradeComments').value,
            graded_by: currentUser.name
        };
    } else {
        manualScore = parseInt(document.getElementById('manualScore').value);
        if (isNaN(manualScore) || manualScore < 0 || manualScore > 100) {
            alert('Enter valid score (0-100)');
            return;
        }
        updates = {
            manual_score: manualScore,
            total_score: manualScore,
            comments: document.getElementById('gradeComments').value,
            graded_by: currentUser.name
        };
    }
    
    const success = await updateGrade(rollNo, updates);
    
    if (success) {
        alert('‚úÖ Grade saved successfully!');
        document.getElementById('gradeModal').classList.remove('active');
        loadDashboard();
    } else {
        alert('‚ùå Failed to save grade');
    }
}

function exportExcel() {
    const rows = dashboardData.map(s => ({
        'Name': s.name,
        'Roll No': s.roll_no,
        'Email': s.email,
        'Phone': s.phone,
        'Department': s.department,
        'Year': s.year,
        'Question': s.question_id,
        'Auto Score': s.total_score || 0,
        'Manual Score': s.manual_score || '',
        'Status': s.status,
        'Time': s.time_taken || '',
        'Graded By': s.graded_by || '',
        'Comments': s.comments || ''
    }));
    
    const ws = XLSX.utils.json_to_sheet(rows);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Submissions');
    XLSX.writeFile(wb, `JKKN_Assessment_${new Date().toISOString().split('T')[0]}.xlsx`);
}

// =====================================================
// INIT
// =====================================================
console.log('üéì JKKN Portal with Supabase REST API Ready');
setTimeout(testConnection, 500);
</script>
</body>
</html>
